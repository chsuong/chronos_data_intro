---
title: "data_intro"
author: "Clara Suong"
date: "11/9/2018"
output:
  pdf_document: default
  html_document: default
  toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

##Load libraries
```{r, results='hide', message=FALSE, warning=FALSE}
rm(list = ls()) 
library(plyr)
library(dplyr)
library(dbplyr)
library(tidyverse)
library(RMySQL) #For connecting to the databse
#library(sjPlot) #For creating Word-compatible tables
#library(labelled)
library(htmlTable)
library(Hmisc)
library(expss)
library(sjlabelled)
library(lubridate)
```

#Databases
* declassification_cables
* declassification_ddrs
* declassification_frus
* declassification_kissinger
* declassification_pdb
* declassification_cabinet
* declassification_clinton 

#Key Variables
* date (year)
* classification
* urgency
* (handling)
* office
* country
* person
* topic
* Link to a label dictionary: https://docs.google.com/document/d/13iM00ZfVzV-6mGw8YBGkJFnJFkLe011znb3LQenaIjM/edit?usp=sharing 

#Database 'declassification_cables'

##Connecting to the database 'declassification_cables'
```{r, results='hide'}
driver = dbDriver("MySQL")
connection = dbConnect(driver,host='history-lab.org', password='XreadF403', user='de_reader')
mydb = dbConnect(driver, 
                       host='history-lab.org', password='XreadF403', user='de_reader',
                       dbname='declassification_cables')
```

##Listing tables in the database 'declassification_cables'
```{r}
dbListTables(mydb)
```

##Exploring the table 'docs' in the database 'declassification_cables'
```{r,results='hide'}
dbListFields(mydb, 'docs')
print(dbGetQuery(mydb, "Describe docs;"))
#docs<-tbl(mydb, "docs")%>%
#  collect()
```

##Documents by year
```{r}
classification_doc <- tbl(mydb,'classification_doc') %>%
  collect()

classification_doc<-tbl_df(classification_doc) %>%
  mutate(year=year(date))

#year_doc <- tbl_df(classification_doc) %>%
#  mutate(year=year(date))%>%
#  count(year) %>%
#  mutate(rel.freq = paste0(round(100 * n/sum(n), 0), "%"))%>%
#  arrange(year)%>%
#  set_caption("Table: Documents by Year") %>%
#  htmlTable(rnames = FALSE)

classification_doc=apply_labels(classification_doc,
                      year="Year")
  
table_year=fre(classification_doc$year)%>%
  set_caption("Table: Documents by Year") %>%
  htmlTable()
table_year
```

##Listing the fields in the tables for classification
```{r,results='hide'}
dbListFields(mydb, 'classifications')
dbListFields(mydb, 'classification_doc')
print(dbGetQuery(mydb, "Describe classifications;"))
print(dbGetQuery(mydb, "Describe classification_doc;"))
classifications <- tbl(mydb, "classifications")
classifications
classification_doc <- tbl(mydb, "classification_doc")
classification_doc
```

##Documents by classification in the database 'declassification_cables'
```{r}

classification_doc <- tbl(mydb,'classification_doc') %>%
  collect()

classification_doc=apply_labels(classification_doc,
                      classification_id="Classification",
                      classification_id=num_lab("1 Secret
                                                2 Confidential
                                                7 Limited Official Use
                                                5 Unclassified")#,
                      #n="Number of Documents",
                      #rel_freq="Proportion"
                                  )

table_classification = fre(classification_doc$classification_id) %>% 
    set_caption("Table: Documents by Classification") %>%
    htmlTable()

table_classification

#sjt.xtab(classification_doc$classification_id)
```

##Listing fields in the tables for urgency 
```{r,results='hide'}
dbListFields(mydb, 'urgency')
dbListFields(mydb, 'urgency_doc')
print(dbGetQuery(mydb, "Describe urgency;"))
print(dbGetQuery(mydb, "Describe urgency_doc;"))
urgency <- tbl(mydb, "urgency")
urgency
urgency_doc <- tbl(mydb, "urgency_doc")
urgency_doc
```

##Documents by urgency in the database 'declassification_cables'
```{r}
urgency_doc <- tbl(mydb,'urgency_doc') %>%
  collect()

urgency_doc=apply_labels(urgency_doc,
                      urgency_id="Urgency",
                      urgency_id=num_lab("1	Flash			
                                          2	Night Action			
                                          3	Immediate")#,
                      #n="Number of Documents",
                      #rel_freq="Proportion"
                                  )

table_urgency = fre(urgency_doc$urgency_id) %>% 
    set_caption("Table: Documents by Urgency") %>%
    htmlTable()

table_urgency
```

##Documents by handling in the database 'declassification_cables'
```{r, include=FALSE}
#load("~/Dropbox/nyu_postdoc/ner/dataset_intro/cfpf_docs.RData")

#plyr::count(docs$handling, rownames=FALSE)

#fre(docs$handling)

#table_handling = fre(docs$handling) %>% 
#    set_caption("Table: Documents by Handling") %>%
#    htmlTable()

#table_handling
```

##Listing fields in the tables for office
```{r,results='hide'}
dbListFields(mydb, 'offices')
dbListFields(mydb, 'office_doc')
print(dbGetQuery(mydb, "Describe offices;"))
print(dbGetQuery(mydb, "Describe office_doc;"))
offices <- tbl(mydb, "offices")
offices
#offices<-as.data.frame(offices)
#print(offices, row.names = FALSE)
office_doc <- tbl(mydb, "office_doc")
office_doc
```

##Documents by office in the database 'declassification_cables'
```{r,results='hide'}
office_doc <- tbl(mydb,'office_doc') %>%
  collect()

office_doc=apply_labels(office_doc,
                      office_id="Office",
                      office_id=num_lab("   1    SIA
   2    SIG
   3    CPR
   4    AGR
   5    SIL
   6   DODE
   7   DODM
   8    SPH
   9   DODW
  10    SPM
  11    SPC
  12    SPD
  13    WRD
  14   INRE
  15   INRD
  16   INRN
  17      P
  18  ACDAA
  19   NEAE
  20  ACDAE
  21    SNN
  22    SNM
  23    LAB
  24    SNP
  25   CIAE
  26   CIAO
  27   SLPD
  28   CIAW
  29    PCH
  30   IDCA
  31    HUD
  32    FTC
  33    IGA
  34    DSE
  35  AGREE
  36    TAR
  37     MC
  38     MB
  39    INT
  40    INV
  41    INR
  42    INS
  43   OTPE
  44    INM
  45    INC
  46   STPA
  47     FS
  48   STPE
  49   INSA
  50    SMS
  51    DOD
  52    DOE
  53   SSLG
  54    SMI
  55   SCCT
  56    DOT
  57     FO
  58    FCC
  59  NSCEE
  60      E
  61      F
  62   OESN
  63    JEA
  64   EURE
  65    FMC
  66     SY
  67   SARN
  68     SS
  69     SR
  70     SP
  71    MMS
  72     ST
  73    MMO
  74    ORM
  75     SO
  76     SL
  77     SC
  78    ALS
  79   SART
  80    DPW
  81     YO
  82   CIEE
  83    OFA
  84    CAB
  85    BAL
  86   CIEP
  87     LB
  88   NASA
  89     LS
  90   ASIS
  91    STD
  92    STE
  93    ABF
  94    LOG
  95    STR
  96    RSE
  97    RSC
  98   FDRE
  99    NSA
 100   ODRC
 101    RSR
 102    LIB
 103   SPTA
 104   OCPE
 105   FILE
 106   ARAE
 107   SDEL
 108    SAJ
 109     RP
 110    SAM
 111    SAL
 112    SAB
 113    SAA
 114    SAE
 115  NSAEE
 116   MOFM
 117     RA
 118    PRS
 119     RC
 120    SAS
 121   OPIC
 122  USSSE
 123   JMDE
 124      L
 125  USSSS
 126    NEA
 127   BCCE
 128    SFW
 129   DLOS
 130    IFT
 131      A
 132  INSEE
 133    NGA
 134    WFC
 135    OCE
 136    KSO
 137    OCT
 138    OCV
 139    CEA
 140  DLOSP
 141    CEQ
 142   NSCE
 143  CIEPP
 144   TRRE
 145     EA
 146    CSC
 147     EB
 148   USSS
 149      W
 150 AGRNOE
 151     VO
 152     ES
 153    SSM
 154    SSO
 155    SSN
 156    SSA
 157    SSC
 158    MUR
 159   AIDE
 160    ISO
 161    SES
 162   FCSC
 163  OTRSE
 164    SEC
 165    NUA
 166   ITFE
 167    FRB
 168   WRDE
 169      B
 170   TFCE
 171      R
 172     NR
 173    EUR
 174    OMB
 175    ITF
 176    ITC
 177   OISO
 178     DE
 179     DA
 180   AGRE
 181     DS
 182   USIA
 183   USIE
 184    BIB
 185   AECE
 186   INTE
 187      M
 188    DHA
 189   ICAE
 190   COPY
 191  ERDAE
 192    MCE
 193   USPS
 194    NRE
 195    OTP
 196    MCT
 197    DZC
 198  DODEN
 199    OKT
 200    JUS
 201   DKDE
 202    DCT
 203    IWY
 204    GPO
 205    IAE
 206      H
 207   PASO
 208   BNDD
 209   BNDE
 210   PASS
 211   CPSC
 212    SYE
 213    NIC
 214    OIC
 215   ANAE
 216   FBOE
 217   AMAD
 218   SCEM
 219   TRSE
 220    SKE
 221    AEC
 222   TRSY
 223    TIF
 224   MEEO
 225   ABMC
 226     PC
 227     PA
 228     PM
 229      C
 230    FOE
 231      S
 232   DOTE
 233    OPR
 234     RS
 235   SPRS
 236   STRN
 237    OPM
 238    MOF
 239   STRE
 240    FSE
 241   ITAF
 242    FSG
 243    FSI
 244    PER
 245    COA
 246    COM
 247    CIE
 248   CIAU
 249   SCSE
 250    TVA
 251    HEW
 252     RB
 253    IEP
 254     CA
 255    ZTF
 256     CG
 257    XMB
 258   FAIM
 259    SWF
 260   COME
 261     CU
 262     CT
 263  TRSEL
 264    CDA
 265    CDC
 266    OES
 267  TRSEE
 268    OEP
 269   MBFR
 270    PLE
 271    OEO
 272    LOC
 273   INSE
 274    AIT
 275   CTME
 276    AID
 277    AIF
 278    SOE
 279  OTPEE
 280    NSC
 281    NSE
 282    NSF
 283   FEMA
 284    GAO
 285    PPT
 286    FAA
 287     VA
 288    SVC
 289     IO
 290     IC
 291     IE
 292     ID
 293    IRF
 294   FSIE
 295   ALPS
 296    ARA
 297    OAB
 298    EAE
 299    ONY
 300   DEAE
 301    GSA
 302    NAS
 303    CCO
 304    OAS
 305    EPG
 306    DRC
 307    EPA
 308   FDIC
 309  INRED
 310    IOE
 311  COMEE
 312   ACDA
 313   ACDE
 314      T
 315   PPTE
 316  INRES
 317   DOEE
 318  TRSYY
 319     OC
 320     OS
 321   EPAE
 322   FEAE
 323   DIWY
 324    DEA
 325     HA
 326    SCL
 327    SCI
 328    SCA
 329    SCT
 330    SCS
 331   LABE
 332      O
 333   JUSE
 334    VOE
 335   FBIE
 336    ACD
 337   DUMY
 338    OCL
 339  USIEA
 340     NE
 341   NSAO
 342   ERDE
 343    PMN
 344   ERDA
 345   NSAE
 346    ADS
 347    ADP
 348    FEA
 349  CIAEE
 350   NTIE
 351   NTIA
 352    MED
 353   EXIM
 354  JUSES
 355    NRC
 356   BOOK
 357    FBI
 358    FBO
 359    CIA
 360   MFLO
 361    MSC
 362    OCS
 363     TR
 364   COMP
 365    EAP
 366   ALSE
 367     AE
 368    FPC
 369     AF
 370    ICA
 371     AJ
 372    ICE
 373   AFSA
 374     AS
 375     AR
 376    HHS")#,
                      #n="Number of Documents",
                      #rel_freq="Proportion"
                                  )

table_office = fre(office_doc$office_id) %>% 
    set_caption("Table: Documents by Office") %>%
    htmlTable()

table_office
```

##Documents by top 10 offices in the database 'declassification_cables'
```{r}
table_office_top10<- tbl_df(office_doc) %>%
  count(office_id) %>%
  mutate(rel.freq = paste0(round(100 * n/sum(n), 0), "%"))%>%
  top_n(10)%>%
  arrange(desc(n))%>%
  as_label(office_id)%>%
  as_label(var.label=c("Office","Number of Documents", "Relative Frequency"))%>%
  set_caption("Table: Documents by Office") %>%
  htmlTable(rnames = FALSE)
  
table_office_top10  
```

##Documents by top 10 countries in the database 'declassification_cables'
```{r}
country_doc <- tbl(mydb,'country_doc') %>%
  collect()

table_country_top10<- tbl_df(country_doc) %>%
  count(country_id) %>%
  mutate(rel.freq = paste0(round(100 * n/sum(n), 0), "%"))%>%
  top_n(10)%>%
  arrange(desc(n))%>%
  as_label(country_id)%>%
  set_caption("Table: Documents by Country") %>%
  htmlTable(rnames = FALSE)
  
table_country_top10  
```

##Documents by top 10 persons in the database 'declassification_cables'
```{r, results=hide}
dbListFields(mydb, 'person_doc')
#Table 'person_doc' needs to be populated.
```

##Documents by top 10 topics in the database 'declassification_cables'
```{r, results=hide}
topic_doc <- tbl(mydb,'topic_doc') %>%
  collect()

table_topic_top10<- tbl_df(topic_doc) %>%
  count(topic_id) %>%
  mutate(rel.freq = paste0(round(100 * n/sum(n), 0), "%"))%>%
  top_n(10)%>%
  arrange(desc(n))%>%
  #as_label(country_id)%>%
  set_caption("Table: Documents by Topic") %>%
  htmlTable(rnames = FALSE)
  
table_topic_top10  
```

#Database 'declassification_ddrs'

##Connecting to the MySQL database 'declassification_ddrs'
```{r, results='hide'}
driver = dbDriver("MySQL")
connection = dbConnect(driver,host='history-lab.org', password='XreadF403', user='de_reader')

mydb = dbConnect(driver, 
                       host='history-lab.org', password='XreadF403', user='de_reader',
                       dbname='declassification_ddrs')
```

##Listing tables in the database 'declassification_ddrs'
```{r}
dbListTables(mydb)
```

```{r pressure, include=FALSE, echo=FALSE}
plot(pressure)
```

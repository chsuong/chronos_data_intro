---
title: "data_intro"
author: "Clara Suong"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  pdf_document: default
  html_document: default
  toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

##Load libraries and set the working directory
```{r, results='hide', message=FALSE, warning=FALSE}
rm(list = ls()) 
library(plyr)
library(dplyr)
library(dbplyr)
library(tidyverse)
library(tidyquant) # Loads tidyverse, tidquant, financial pkgs, xts/zoo
library(xts) #Time series
library(RMySQL) #For connecting to the databse
#library(sjPlot) #For creating Word-compatible tables
#library(labelled)
library(htmlTable) #For creating Word-compatible tables
library(Hmisc)
library(expss) #For creating Word-compatible tables
library(sjlabelled)
library(lubridate)
library(foreign)
library(ggplot2)
library(reshape2)
library(readxl)
library(countrycode) #For reconciling different country codes across dataset
library(fuzzyjoin) #For reconciling different country codes across dataset
library(ISOcodes) #A package for ISO country codes
library(MASS) #Negative binomial models
library(stargazer)

getwd()
setwd(dirname(getwd()))
#setwd("/Users/clarahsuong/Dropbox/nyu_postdoc/ner/dataset_intro") #If necessary, set as the working directory a location where you can save large data files with file size over 100 mb (github limitation).
#Create a folder named "external_data" in the working directory
```

#Databases and external datasets

##Our MySQL databases
* declassification_cables
* declassification_ddrs
* declassification_frus
* declassification_kissinger
* declassification_pdb
* declassification_clinton 
* declassification_cabinet
* declassification_cpdoc

##Key fields/variables in our database 'declassification_cables'
* body
* subject
* date (year)
* classification
* urgency
* length
* (handling)
* (page_count)
* (line_count)
* office
* from_field
* to_field
* tag

* (Derived from TAGS below) 
* country
* person
* topic

* frus_match

* Cf. label dictionary: 
https://docs.google.com/document/d/13iM00ZfVzV-6mGw8YBGkJFnJFkLe011znb3LQenaIjM/edit?usp=sharing 

##External dataset source:
* Download the following datasets in the folder "external_data"
* COW country codes (cow): http://www.correlatesofwar.org/data-sets/cow-country-codes/cow-country-codes/at_download/file
* U.S. diplomatic representation (us_dip_rep; COW-compatible version): https://www.dropbox.com/sh/2wnklx04vblnmi1/AABmMxbxvja_JVStsxKD4F2Qa?dl=0
* U.S. diplomatic visits (us_dip_vis): https://tinyurl.com/yyedcahu
* U.S. diplomatic appointments (us_dip_app): https://static-content.springer.com/esm/art%3A10.1007%2Fs11558-017-9277-0/MediaObjects/11558_2017_9277_MOESM1_ESM.zip
* UN voting (un_vote): https://dataverse.harvard.edu/dataset.xhtml?persistentId=hdl:1902.1/12379
* Actor-level International Crisis Behavior (icb; Version 12): https://sites.duke.edu/icbdata/data-collections/
* U.S. diplomatic events (us_dip_evt): https://www.dropbox.com/sh/d93tdqanxugvlvg/AAByV97aMEE1Ydh0mkihigrSa?dl=0

#Exploring the database 'declassification_cables'

##Connecting to the database 'declassification_cables'
```{r echo=FALSE}
driver = dbDriver("MySQL")
connection = dbConnect(driver,host='history-lab.org', password='XreadF403', user='de_reader')
mydb = dbConnect(driver,host='history-lab.org', password='XreadF403', 
                 user='de_reader', dbname='declassification_cables')
```

##Tables in the database 'declassification_cables'
```{r}
dbListTables(mydb)
#Note that many of the tables are yet to be populated (or in the process of being so).
```

##Exploring the main table 'docs' from the database 'declassification_cables'
```{r echo=FALSE}
dbListFields(mydb, 'docs')
print(dbGetQuery(mydb, "Describe docs;"))

#Download and save the table 'docs' in the working directory
#getwd()
#docs<-tbl(mydb, "docs")%>%
#  collect() 

#save(docs, file = "/Users/clarahsuong/Dropbox/nyu_postdoc/ner/dataset_intro/cfpf_docs.RData")
#load("/Users/clarahsuong/Dropbox/nyu_postdoc/ner/dataset_intro/cfpf_docs.RData")

#Note that not all cables with the value "full" for the variable "cable_type" actually include full text. 
#Also note that variables like "page_count" and "line_count" are not really valid for cables without full text.
#prop.table(table(docs$cable_type))
#head(docs[,c("cable_type","body")], 20)
```

##Examine the different country codes across datasets
```{r, results='hide', message=FALSE, warning=FALSE}
#Re-connect to the database
driver = dbDriver("MySQL")
connection = dbConnect(driver,host='history-lab.org', password='XreadF403', user='de_reader')
mydb = dbConnect(driver,host='history-lab.org', password='XreadF403', user='de_reader', dbname='declassification_cables')

countries<-
  tbl(mydb, 'countries') %>% 
  collect() #Note that there is no tag for "South Vietnam" but tag "VM" (id: 557) for "Vietnam" accoring to this table. There is also no tag for Serbia and Montenegro.

countries2<-
  tbl(mydb, 'countries') %>% 
  collect() %>%
  mutate(country_id=as.integer(id)) %>%
  dplyr::select(-id)

cow<-read_csv("../external_data/cow/COW country codes.csv") %>%
  distinct()

#Generate a list of existing country-year pairs for the 1970s (a universe of all possbiel diplomatic relations).
#states_y<-
#  read_csv("../external_data/cow/states2016.csv") %>%
#  select(stateabb, ccode, statenme, styear, endyear) %>%
#  mutate

countries3<-
  read_csv("../external_data/lebovic_saunders_2016/diplomatic_core.replication.csv") %>%
  filter(year>1969 & year<1981) %>%
  dplyr::select(cowid, year) %>%
  rename(cow_ccode=cowid)#Note: cannot automatically complete the data frame with missing combinations of data (function complete) because we need to account for the difference in countries' birth date. Use the dataframe us_dip_vis below for now. Create the full list of country-year combinations later. 

#Merge ISO_3166_1 and ISO_3166_3 (ISO country codes for withdrawn countries). Note that this list often omits retired codes. 

iso_3166<-
  tibble::as_tibble(left_join(ISO_3166_1, ISO_3166_3, by = c("Alpha_3","Numeric","Name")))%>%
  mutate(Numeric=as.integer(Numeric)) %>%
  dplyr::select("Alpha_3",
         "Numeric",
         "Name",
         "Official_name",
         "Common_name") 

#Check whether the variable "country_id" in the table "countries" is from ISO 3166.
#Derive COW country codes from the variable "name" in the table "countries."
countries2$cow_ccode<-countrycode(countries2$name, 'country.name', 'cown') #cow_ccode for Vietnam should be 816, not 817 (error in the package countrycode) and cow_ccode for West Germany (German Federal Republic) should be 260.
#countries2$cowid2<-countrycode(countries2$country_id, 'iso3n', 'cown')
countries2$iso3n<-countrycode(countries2$name, 'country.name', 'iso3n') #iso3n for South Vietnam should not be 704 (country code of Vietnam) (error in the package countrycode).

all(countries2$country_id %in% iso_3166$Numeric)
all(iso_3166$Numeric %in% countries2$country_id)
setdiff(countries2$country_id, iso_3166$Numeric)
countries2[countries2$country_id %in% setdiff(countries2$country_id, iso_3166$Numeric),]
#Most of the items with a discrepancy between the database's country ids and iso-3166 numeric seem to be defunct states or non-state entities, except East and West Germany.

#Focus on countries by dropping the observations with missing tag_id or COW country code.
countries2<-
  countries2[!is.na(countries2$cow_ccode) & !is.na(countries2$tag_id),] %>%
  mutate(cow_ccode= replace(cow_ccode, name=="Vietnam", 816)) %>% #Fix cow_ccode for Vietnam 
  mutate(cow_ccode= replace(cow_ccode, name=="West Germany", 260)) %>% #Fix cow_ccode for West Germany (German Federal Republic) 
  left_join(cow, by=c("cow_ccode"="CCode")) %>% 
  rename(country_name=name,
         cow_stateabb=StateAbb, 
         cow_statename=StateNme) %>%
  dplyr::select(-iso3n) 
#Germany and West Germany share their COW country codes.
```

##Cable Traffic

###Download, save, or load the tables for tags and docs (doc_id and date) in the working directory and count the number of cables tagged for each country
```{r results='hide', message=FALSE, warning=FALSE}
#Re-connect to the database
#driver = dbDriver("MySQL")
#connection = dbConnect(driver,host='history-lab.org', password='XreadF403', user='de_reader')
#mydb = dbConnect(driver,host='history-lab.org', password='XreadF403', user='de_reader', dbname='declassification_cables')

tags<-
  tbl(mydb, 'tags') %>% 
  dplyr::select(id, tag, category) #%>% collect()

tag_doc<-
  tbl(mydb, 'tag_doc') #%>% collect()

doc_date2<-
  tbl(mydb, 'docs') %>% 
  dplyr::select(id, date) %>%
  rename(doc_id=id) #%>% collect()

#tag_doc2<-
#  tag_doc%>%
#  inner_join(tags, by = c("tag_id"="id")) %>%
#  inner_join(doc_date2, by = "doc_id") %>%
#  mutate(year=lubridate::year(date), 
#         month=lubridate::month(date), 
#         date=lubridate::ymd(date), 
#         ym=as.yearmon(paste(year, month),"%Y %m")
#         ) %>%
#  collect() 
#save(tag_doc2, file = "../data/tag_doc2.RData")
load("../data/tag_doc2.RData")

#tag_doc2_country <-
#  tag_doc2 %>%
#  inner_join(countries2, by="tag_id") 
#save(tag_doc2_country, file = "../data/tag_doc2_country.RData")
load("../data/tag_doc2_country.RData")

#cable_n_country_date<-
#  tag_doc2_country %>%
#  group_by(.dots=c("tag_id", 
#                   "country_id", 
#                   "cow_ccode", 
#                   "country_name", 
#                   "date")) %>%
#  tally() 
#save(cable_n_country_date, file = "../data/cable_n_country_date.RData")
load("../data/cable_n_country_date.RData")
```

###Examine cables tagged with certain countries as a test
```{r}

#Check tag_id for certain countries
countries2%>%filter(str_detect(country_name, 'China'))
countries2%>%filter(str_detect(country_name, 'Korea'))
countries2%>%filter(str_detect(country_name, 'Viet'))
countries2%>%filter(str_detect(country_name, 'Afghan'))
countries2%>%filter(str_detect(country_name, 'Iran'))
countries2%>%filter(str_detect(country_name, 'Germany'))
countries2%>%filter(str_detect(country_name, 'Egypt'))

cable_china<-
  tag_doc2 %>%
  filter(tag_id==386) %>%
  group_by(date) %>%
  tally() 
  
cable_nkorea<-
  tag_doc2 %>%
  filter(tag_id==453)%>%
  group_by(date) %>%
  tally() 

cable_viet<-
  tag_doc2 %>%
  filter(tag_id==557) %>%
  group_by(date) %>%
  tally() 
#Note that the tag for South Vietnam is "deleted" and its tag_id missing.

cable_afghan<-
  tag_doc2 %>%
  filter(tag_id==342) %>%
  group_by(date) %>%
  tally()

cable_iran<-
  tag_doc2 %>%
  filter(tag_id==440) %>%
  group_by(date) %>%
  tally() 

cable_east_germany<-
  tag_doc2 %>%
  filter(tag_id==419) %>%
  group_by(date) %>%
  tally() 

cable_egypt<-
  tag_doc2 %>%
  filter(tag_id==402) %>%
  group_by(date) %>%
  tally() 
```

#Yearly cable traffic
```{r, results="hide"}
cable_n_country_y<-
  cable_n_country_date %>%
  mutate(year=lubridate::year(date)) %>%
  group_by(year, cow_ccode, country_name) %>%
  summarise(y_n = sum(n)) 
```

#Descriptive statistics
```{r, results="hide",message=FALSE}
stargazer(as.data.frame(cable_n_country_y), 
          type = "html", 
          title="Descriptive statistics of yearly cable traffic", 
          digits=1, 
          out="../data_analysis_output/desc_cable_n_country_y.html"#,
          #covariate.labels=c("Miles/(US)gallon",)
          )
```

#Import and load the COW data for U.S. diplomatic representation
```{r results='hide', message=FALSE, warning=FALSE}
us_dip_rep1<-
  read_csv("../external_data/cow_diplomatic_exchange_2006.1/Diplomatic_Exchange_2006v1.csv", locale = locale(encoding = "UTF-8")) 
```

#Import and load Moyer et al's data for U.S. diplomatic representation
```{r results='hide', message=FALSE, warning=FALSE}
us_dip_rep2<-
  read_csv("../external_data/moyeretal2016/Pardee Center Diplomatic Representation_COW 20190208.csv", locale = locale(encoding = "UTF-8")) %>% #COW-compatible version
#  read_excel("../external_data/moyeretal2016/Diplomatic_Exchange_V3.16.16.xlsx") %>% #Non-compatible, public version
  mutate(Year=as.numeric(Year)) %>%
  rename(year = Year) %>%
  filter(Country=="United States of America" & year>1969 & year<1981) %>%
#  filter(Country=="United States of America") %>% 
  mutate(date = ymd(paste0(year, "-", 06, "-", 01))) %>% #us_dip_rep[is.na(us_dip_rep$cow_ccode),] COW country code for East Germany is missing.
  left_join(countries2, by=c("Destination"="cow_statename"))  
```

##Examine cables tagged with certain countries as a test
```{r}
#Examine some countries
us_dip_rep_china<-
  filter(us_dip_rep2, cow_ccode==710) %>%
  mutate(dip_rep=ifelse(`Embassy New`==6,1, NA))

#Note that the dataset is inaccurately referring to South Vietnam as Vietnam.
#us_dip_rep_viet<-
#  filter(us_dip_rep2, cow_ccode==816) %>%
#  mutate(dip_rep=ifelse(`Embassy New`==6,1, NA))

us_dip_rep_iran<-
  filter(us_dip_rep2, cow_ccode==630) %>%
  mutate(dip_rep=ifelse(`Embassy New`==6,1, NA))

us_dip_rep_afghan<-
  filter(us_dip_rep2, cow_ccode==700) %>%
  mutate(dip_rep=ifelse(`Embassy New`==6,1, NA))

#No diplomatic relations between the U.S. and (North) Vietnam until 1995
#No formal relations between the U.S. and North Korea
```  
  
#Import and load the data on U.S. diplomatic appointments and inferred representation
```{r}  
#Save the dta file as a csv file and read in the csv file
#write.csv(read.dta("../external_data/arias_smith_2018/ambassadors.dta"),"../external_data/arias_smith_2018/ambassadors.csv")

us_dip_irep_app <-  
  read_csv("../external_data/arias_smith_2018/ambassadors.csv", guess_max = 100000) %>%
  filter(year>1969 & year<1981) %>%
  dplyr::select(year, ccode, country_ambassador, position, ambassador, politicalappointee,good, bad) %>%
  rename(cow_ccode=ccode, ambassador_name=ambassador) %>%
  right_join(countries3, by=c("cow_ccode", "year")) %>% #Note: cannot automatically complete the data frame with missing combinations of data (function complete) because we need to account for the difference in countries' birth date. Use the dataframe us_dip_vis below for now. Create the full list of country-year combinations later.  
  arrange(cow_ccode, year) %>%
  mutate(dip_irep=ifelse(is.na(country_ambassador),0, 1)) %>% #Created a variable for inferred US representation. Check this variable against the dataset by Moyer 2016. There may be a discrepancy due to bureaucratic delays and so on. For instance, there may be a diplomatic relationship but there is a delay in confirming him/her and the DCM serves as CM instead. 
  mutate(ambassador=ifelse(position=="Ambassador Extraordinary and Plenipotentiary",1, 0))
  
```

#Import and load the data on U.S. diplomatic visits
```{r, results='hide', message=FALSE, warning=FALSE}
#Save the dta file as a csv file
#write.csv(read.dta("diplomatic_core.replication.dta"),"../external_data/lebovic_saunders_2016/diplomatic_core.replication.csv")

#Note that the paper (LEBOVIC AND SAUNDERS 2016) mentions the variable for crisis (Crisis Shocks from the International Crisis Behavior Project) but the dataset actually does not include it. The paper notes that "regularized patterns [of U.S. diplomatic visits] that we discern are not products of crisis diplomacy and that crises do not strongly affect the results" (p.119).
us_dip_vis<-
  read_csv("../external_data/lebovic_saunders_2016/diplomatic_core.replication.csv") %>%
  filter(year>1969 & year<1981) %>%
  dplyr::select(cowid, year, bi_PRE, bi_SOS, mil_ratio, USmilaid, allies, USdefense, USdefense_EUR, UStrade, energypc, USalign, UNpart, mpower, term2, NIX, FOR, CAR, demo, bi_L1_PRE, EUR, AFR, MEA, SCA, EAP, bi_L14_SOS, bi_L14_PRE, bi_L58_SOS, bi_L58_PRE) %>%
  left_join(cow, by=c("cowid"="CCode"))  #%>%
  #mutate(un_member= ifelse(!is.na(UNpart),1, NA)) #Check whether newly admitted states participate in UN voting only the year after

#a<-us_dip_vis[us_dip_vis$UNpart==0,]
```

###Examine cables tagged with certain countries as a test
```{r}

us_dip_vis_china<-
  filter(us_dip_vis, cowid==710)

us_dip_vis_nkorea<-
  filter(us_dip_vis, cowid==731)

us_dip_vis_viet<-
  filter(us_dip_vis, cowid==816)

us_dip_vis_iran<-
  filter(us_dip_vis, cowid==630)

us_dip_vis_afghan<-
  filter(us_dip_vis, cowid==700)

us_dip_vis_egypt<-
  filter(us_dip_vis, cowid==651)

us_dip_vis_east_germany<-
  filter(us_dip_vis, cowid==265)
```

#Import and load the data on US diplomatic events
```{r results="hide"}
us_dip_evt<-
  read_csv("../external_data/carter2018/AmericanDiplomacyDataset.csv") 

#Check whether the country abbreviations are from COW or ISO-3166.
all(us_dip_evt$source %in% countries2$cow_stateabb)
all(us_dip_evt$target %in% countries2$cow_stateabb)
all(us_dip_evt$source %in% iso_3166$Alpha_3)
all(us_dip_evt$target %in% iso_3166$Alpha_3)

setdiff(us_dip_evt$source, countries2$cow_stateabb)
setdiff(us_dip_evt$target, countries2$cow_stateabb)
setdiff(us_dip_evt$source, iso_3166$Alpha_3)
setdiff(us_dip_evt$target, iso_3166$Alpha_3)

all(setdiff(us_dip_evt$target, iso_3166$Alpha_3) %in% us_dip_evt$target)
all(setdiff(us_dip_evt$source, iso_3166$Alpha_3) %in% us_dip_evt$source)
all(setdiff(us_dip_evt$target, iso_3166$Alpha_3) %in% iso_3166$Alpha_3)
all(setdiff(us_dip_evt$source, iso_3166$Alpha_3) %in% iso_3166$Alpha_3)

us_dip_evt[us_dip_evt$target %in% setdiff(us_dip_evt$target, iso_3166$Alpha_3),]
us_dip_evt[us_dip_evt$source %in% setdiff(us_dip_evt$source, iso_3166$Alpha_3),]

#It looks like the variables "target" and "source" in the dataset are "the 2-character FIPS10-4 country code for the location" (http://data.gdeltproject.org/documentation/ISA.2013.GDELT.pdf). But these seem to overlap a lot with iso3c

us_dip_evt2<-
  read_csv("../external_data/carter2018/AmericanDiplomacyDataset.csv") %>%
#  filter(1969<year & year<1980) %>%
  mutate(ym=as.yearmon(date, "%Y %m"), 
       cow_ccode_source=countrycode(source, 'iso3c','cown'),
       cow_ccode_target=countrycode(target, 'iso3c','cown')) %>%
  mutate(cow_ccode_source= replace(cow_ccode_source, source=="YUG", 345), #The function countrycode did not identify "YUG" as Yugoslavia.
         cow_ccode_target = replace(cow_ccode_target, target=="YUG", 345), #The function countrycode did not identify "YUG" as Serbia, then part of Yugoslavia.
         cow_ccode_source= replace(cow_ccode_source, source=="SER", 345), #The function countrycode did not identify "SER" as Serbia, then part of Yugoslavia.
         cow_ccode_target = replace(cow_ccode_target, target=="SER", 345)) #The function countrycode did not identify "SER" as Serbia, then part of Yugoslavia.

#Entities with missing COW country codes are non-state. Let's drop or fix them.
table(us_dip_evt[is.na(us_dip_evt$cow_ccode_source),]$source)
table(us_dip_evt[is.na(us_dip_evt$cow_ccode_target),]$target)
#AUH: Abu Dhabi before it became part of UAE in December 1971. 
#BMU: Bermuda
#CYM: Cayman Islands 
#HKG: Hong Kong before it became part of China in 1997
#PSE: Palestine
#SER: Yugoslavia? (https://wits.worldbank.org/wits/wits/witshelp/content/codes/country_codes.htm)
#TBT: Tibet (Dalai Lama visited the US on Sep.3-Oct.21, 1979 (https://www.dalailama.com/the-dalai-lama/events-and-awards/travels/travels-1959-1979).)  
#TMP: East Timor (https://wits.worldbank.org/wits/wits/witshelp/content/codes/country_codes.htm)
#VMN: a typo for VNM (Vietnam)? 
#YUG: Transitional reservations for former Yugoslavia/Serbia and Montenegro (https://en.wikipedia.org/wiki/ISO_3166-1_alpha-3 https://wits.worldbank.org/wits/wits/witshelp/content/codes/country_codes.htm)
```

#Import and load the data on international crises
```{r results="hide"}
icb<-
  read_csv("../external_data/icb/icb2v12.csv") %>%
#Rule out crises that end before 1970 and crises that start after 1979
  filter(yrterm>1969 & systrgyr<1980) %>%
  mutate(ym_term=as.yearmon(paste(yrterm, moterm),"%Y %m"), 
         ym_trg=as.yearmon(paste(systrgyr, systrgmo), "%Y %m"), 
         duration=(ym_term-ym_trg)*12) #%>% #Some crises are missing the day of occurence but most have the month and the year.

#Note that the longest duration of a crisis (from a trigger event to its termination) is 3 years.
#max(icb$yrterm-icb$systrgyr, na.rm=TRUE)
```

#Compare the monthly cable traffic with the data on international crises
```{r}

```

#Compare the yearly cable traffic with the country-year data on (inferred) diplomatic representation
```{r, results="hide",warning=FALSE,message=FALSE}
cable_n_irep_app<-
  cable_n_country_y %>%
  inner_join(us_dip_irep_app, by=c("year", "cow_ccode")) 

glm.nb_irep1 <- glm.nb(y_n~dip_irep, data = cable_n_irep_app)

glm.nb_amb <- glm.nb(y_n~ambassador, data = cable_n_irep_app)

glm.nb_politicalappointee <- glm.nb(y_n~politicalappointee, data = cable_n_irep_app)

glm.nb_good <- glm.nb(y_n~good, data = cable_n_irep_app)

glm.nb_bad <- glm.nb(y_n~bad, data = cable_n_irep_app)

stargazer(glm.nb_irep1,
          glm.nb_amb,
          glm.nb_politicalappointee, 
          glm.nb_good,
          glm.nb_bad,
          type="text",
          dep.var.labels=c("Number of Cables Tagged"),
          #covariate.labels=c("Gross horsepower","Rear axle ratio","Four foward gears","Five forward gears","Type of transmission (manual=1)"), 
          out="../data_analysis_output/cable_n_irep_app.txt")

stargazer(glm.nb_irep1,
          glm.nb_amb,
          glm.nb_politicalappointee, 
          glm.nb_good,
          glm.nb_bad,
          type="html",
          dep.var.labels=c("Number of Cables Tagged"),
          #covariate.labels=c("Gross horsepower","Rear axle ratio","Four foward gears","Five forward gears","Type of transmission (manual=1)"), 
          out="../data_analysis_output/cable_n_irep_app.html")


```

#Slightly modified from the analysis in Lebovic and Saunders (2016)' Tables 3 and 4
glm.nb_pre2 <- glm.nb(y_n~bi_PRE+mil_ratio+USmilaid+allies+USdefense+USdefense_EUR+UStrade+energypc+USalign+UNpart+mpower+FOR+CAR+demo+bi_L1_PRE+EUR+AFR+MEA+SCA+EAP, data = cable_n_vis_country_y)
#Cluster by cowid

glm.nb_sos2 <- glm.nb(y_n~bi_SOS+mil_ratio+USmilaid+allies+USdefense+USdefense_EUR+UStrade+energypc+USalign+UNpart+mpower+FOR+CAR+demo+bi_L1_PRE+EUR+AFR+MEA+SCA+EAP, data = cable_n_vis_country_y)
#Cluster by cowid

glm.nb_pre3 <- glm.nb(y_n~bi_PRE+mil_ratio+USmilaid+allies+USdefense+USdefense_EUR+UStrade+energypc+USalign+UNpart+mpower+FOR+CAR+demo+bi_L14_SOS+bi_L14_PRE+bi_L58_SOS+bi_L58_PRE+EUR+AFR+MEA+SCA+EAP, data = cable_n_vis_country_y)
#Cluster by cowid

glm.nb_sos3 <- glm.nb(y_n~bi_SOS+mil_ratio+USmilaid+allies+USdefense+USdefense_EUR+UStrade+energypc+USalign+UNpart+mpower+FOR+CAR+demo+bi_L14_SOS+bi_L14_PRE+bi_L58_SOS+bi_L58_PRE+EUR+AFR+MEA+SCA+EAP, data = cable_n_vis_country_y)
#Cluster by cowid

#Check model assumptions and robustness (https://stats.idre.ucla.edu/r/dae/negative-binomial-regression/)

#Consider using the event count time series models PAR(p) and PEWMA models (http://www.utdallas.edu/~pbrandt/Patrick_Brandts_Website/Code_%26_Software.html) or negative binomials or tscount (https://cran.r-project.org/web/packages/tscount/vignettes/tsglm.pdf) for robustness check.

#Negotive binomial regression models
stargazer(glm.nb_pre1, glm.nb_pre2, glm.nb_pre3, 
          type="html",
          dep.var.labels=c("Number of Cables Tagged"),
          #covariate.labels=c("Gross horsepower","Rear axle ratio","Four foward gears","Five forward gears","Type of transmission (manual=1)"), 
          out="../data_analysis_output/cable_n_pres_visit.html"
          )

stargazer(glm.nb_sos1, glm.nb_sos2, glm.nb_sos3, 
          type="html",
          dep.var.labels=c("Number of Cables Tagged"),
          #covariate.labels=c("Gross horsepower","Rear axle ratio","Four foward gears","Five forward gears","Type of transmission (manual=1)"), 
          out="../data_analysis_output/cable_n_sos_visit.html"
          )

stargazer(glm.nb_pre1, glm.nb_pre2, glm.nb_pre3, glm.nb_sos1, glm.nb_sos2, glm.nb_sos3, 
          type="html",
          dep.var.labels=c("Number of Cables Tagged"),
          #covariate.labels=c("Gross horsepower","Rear axle ratio","Four foward gears","Five forward gears","Type of transmission (manual=1)"), 
          out="../data_analysis_output/cable_n_visit.html")

stargazer(glm.nb_irep1, glm.nb_app1,
          type="text",
          dep.var.labels=c("Number of Cables Tagged"),
          #covariate.labels=c("Gross horsepower","Rear axle ratio","Four foward gears","Five forward gears","Type of transmission (manual=1)"), 
          out="../data_analysis_output/cable_n_irep_app.txt")
```

#Compare the yearly cable traffic with the country-year data on diplomatic visits
```{r, results="hide",warning=FALSE,message=FALSE}
cable_n_vis_country_y<-
  cable_n_country_y %>%
  rename(cowid=cow_ccode) %>%
  inner_join(us_dip_vis, by=c("year", "cowid")) 

glm.nb_pre1 <- glm.nb(y_n~bi_PRE, data = cable_n_vis_country_y)

glm.nb_pre1 <- glm.nb(y_n~bi_PRE, data = cable_n_vis_country_y)
glm.nb_sos1 <- glm.nb(y_n~bi_SOS, data = cable_n_vis_country_y)

#Slightly modified from the analysis in Lebovic and Saunders (2016)' Tables 3 and 4
glm.nb_pre2 <- glm.nb(y_n~bi_PRE+mil_ratio+USmilaid+allies+USdefense+USdefense_EUR+UStrade+energypc+USalign+UNpart+mpower+FOR+CAR+demo+bi_L1_PRE+EUR+AFR+MEA+SCA+EAP, data = cable_n_vis_country_y)
#Cluster by cowid

glm.nb_sos2 <- glm.nb(y_n~bi_SOS+mil_ratio+USmilaid+allies+USdefense+USdefense_EUR+UStrade+energypc+USalign+UNpart+mpower+FOR+CAR+demo+bi_L1_PRE+EUR+AFR+MEA+SCA+EAP, data = cable_n_vis_country_y)
#Cluster by cowid

glm.nb_pre3 <- glm.nb(y_n~bi_PRE+mil_ratio+USmilaid+allies+USdefense+USdefense_EUR+UStrade+energypc+USalign+UNpart+mpower+FOR+CAR+demo+bi_L14_SOS+bi_L14_PRE+bi_L58_SOS+bi_L58_PRE+EUR+AFR+MEA+SCA+EAP, data = cable_n_vis_country_y)
#Cluster by cowid

glm.nb_sos3 <- glm.nb(y_n~bi_SOS+mil_ratio+USmilaid+allies+USdefense+USdefense_EUR+UStrade+energypc+USalign+UNpart+mpower+FOR+CAR+demo+bi_L14_SOS+bi_L14_PRE+bi_L58_SOS+bi_L58_PRE+EUR+AFR+MEA+SCA+EAP, data = cable_n_vis_country_y)
#Cluster by cowid

#Check model assumptions and robustness (https://stats.idre.ucla.edu/r/dae/negative-binomial-regression/)

#Consider using the event count time series models PAR(p) and PEWMA models (http://www.utdallas.edu/~pbrandt/Patrick_Brandts_Website/Code_%26_Software.html) or negative binomials or tscount (https://cran.r-project.org/web/packages/tscount/vignettes/tsglm.pdf) for robustness check.

#Negotive binomial regression models
stargazer(glm.nb_pre1, glm.nb_pre2, glm.nb_pre3, 
          type="html",
          dep.var.labels=c("Number of Cables Tagged"),
          #covariate.labels=c("Gross horsepower","Rear axle ratio","Four foward gears","Five forward gears","Type of transmission (manual=1)"), 
          out="../data_analysis_output/cable_n_pres_visit.html"
          )

stargazer(glm.nb_sos1, glm.nb_sos2, glm.nb_sos3, 
          type="html",
          dep.var.labels=c("Number of Cables Tagged"),
          #covariate.labels=c("Gross horsepower","Rear axle ratio","Four foward gears","Five forward gears","Type of transmission (manual=1)"), 
          out="../data_analysis_output/cable_n_sos_visit.html"
          )

stargazer(glm.nb_pre1, glm.nb_pre2, glm.nb_pre3, glm.nb_sos1, glm.nb_sos2, glm.nb_sos3, 
          type="html",
          dep.var.labels=c("Number of Cables Tagged"),
          #covariate.labels=c("Gross horsepower","Rear axle ratio","Four foward gears","Five forward gears","Type of transmission (manual=1)"), 
          out="../data_analysis_output/cable_n_visit.html")

stargazer(glm.nb_pre1, glm.nb_pre2, glm.nb_pre3, glm.nb_sos1, glm.nb_sos2, glm.nb_sos3, 
          type="text",
          dep.var.labels=c("Number of Cables Tagged"),
          #covariate.labels=c("Gross horsepower","Rear axle ratio","Four foward gears","Five forward gears","Type of transmission (manual=1)"), 
          out="../data_analysis_output/cable_n_visit.txt")
```



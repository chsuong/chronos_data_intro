---
title: "data_intro"
author: "Clara Suong"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  pdf_document: 
    toc: true # table of content true
    toc_depth: 3  # upto three depths of headings (specified by #, ## and ###)
    number_sections: true  ## if you want number sections at each table header
    #theme: united  # many options for theme, this one is my favorite.
    highlight: tango  # specifies the syntax highlighting style
---
\newpage 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
knitr::opts_knit$set(root.dir = "/Users/clarahsuong/chronos_data_intro/")
#knitr::opts_knit$set(root.dir=rprojroot::find_rstudio_root_file("/Users/clarahsuong/chronos_data_intro/"))
#knitr::opts_knit$set(root.dir = normalizePath(".."))
```

#Load libraries and set the working directory
```{r, results='hide'}
rm(list = ls()) # clear objects in memory
library(plyr)
library(dplyr)
library(dbplyr)
library(tidyverse)
library(tidyquant) # Loads tidyverse, tidquant, financial pkgs, xts/zoo
library(xts) #Time series
library(RMySQL) #For connecting to the databse
library(htmlTable) #For creating Word-compatible tables
#library(Hmisc)
#library(expss) #For creating Word-compatible tables
#library(sjlabelled) #For creating Word-compatible tables from pglm models

library(lubridate) #For temporal variables
library(foreign)
library(ggplot2)
library(reshape2)
#library(readxl) #For importing Excel files
library(countrycode) #For reconciling different country codes across dataset
library(ISOcodes) #A package for ISO country codes
#library(MASS) #Negative binomial models
library(stargazer)
library(corrplot)
library(pglm) #For negative binomial models for (unbalanced) panel data
#library(xtable)
#library(gtools)
#library(lmtest)
#library(sandwich)
library(plm) #For linear regression models for (unbalanced) panel data
library(rowr) #For cbind with fill
library(texreg) #Tables for pglm models
library(gtable) #Multiple graphs in one page
library(janitor)
#library(questionr)
#library(questionr) #For freq.na command 
#setwd("/Users/clarahsuong/Dropbox/nyu_postdoc/ner/dataset_intro") #If necessary, set as the working directory a location where you can save large data files with file size over 100 mb (github limitation).
#Create a folder named "external_data" in the working directory
```

#Databases and external datasets

##Our MySQL databases
* declassification_cables
* declassification_ddrs
* declassification_frus
* declassification_kissinger
* declassification_pdb
* declassification_clinton 
* declassification_cabinet
* declassification_cpdoc

##Key fields/variables in our database 'declassification_frus'
* body
* subject
* date (year)
* classification
* urgency
* length
* (handling)
* (page_count)
* (line_count)
* office
* from_field
* to_field
* tag

* (Derived from TAGS below) 
* country
* person
* topic

* frus_match

* Cf. label dictionary: 
https://docs.google.com/document/d/13iM00ZfVzV-6mGw8YBGkJFnJFkLe011znb3LQenaIjM/edit?usp=sharing 

##Key fields/variables in our database 'declassification_cables'
* body
* subject
* date (year)
* classification
* urgency
* length
* (handling)
* (page_count)
* (line_count)
* office
* from_field
* to_field
* tag

* (Derived from TAGS below) 
* country
* person
* topic

##External dataset sources:
* Download the following datasets in the folder "external_data"
* COW country codes (cow): http://www.correlatesofwar.org/data-sets/cow-country-codes/cow-country-codes/at_download/file
* COW diplomatic exchange (us_dip_rep_cow):
http://www.correlatesofwar.org/data-sets/diplomatic-exchange
* U.S. diplomatic representation (us_dip_rep; COW-compatible version): https://www.dropbox.com/sh/2wnklx04vblnmi1/AABmMxbxvja_JVStsxKD4F2Qa?dl=0
* U.S. diplomatic visits (us_dip_vis): https://tinyurl.com/yyedcahu
* U.S. diplomatic appointments (us_dip_app): https://static-content.springer.com/esm/art%3A10.1007%2Fs11558-017-9277-0/MediaObjects/11558_2017_9277_MOESM1_ESM.zip
* U.S. diplomatic events (us_dip_evt): https://www.dropbox.com/sh/d93tdqanxugvlvg/AAByV97aMEE1Ydh0mkihigrSa?dl=0

#Connecting to and exploring the collections

##List the collections
```{r}

setwd("/Users/clarahsuong/chronos_data_intro")

#Re-connect to the database
driver = dbDriver("MySQL")
connection = dbConnect(driver,host='history-lab.org', password='XreadF403', user='de_reader')
dbGetQuery(connection, 'show databases;')
```




##Download the table "docs" for all databases
```{r}
driver = dbDriver("MySQL")
connection = dbConnect(driver,host='history-lab.org', password='XreadF403', user='de_reader')

db_docs <- function(mydb) {
  mydb2 = dbConnect(driver,host='history-lab.org', password='XreadF403', user='de_reader', dbname=mydb)
  docs<-tbl(mydb2, 'docs') %>% 
    collect() %>%
    distinct()
  return(docs)
}

#db_docs('declassification_cables')
#db_docs('declassification_frus')
load("/Users/clarahsuong/Dropbox/nyu_postdoc/ner/dataset_intro/cfpf_docs.RData")
cables_docs<-docs
load("/Users/clarahsuong/Dropbox/nyu_postdoc/ner/dataset_intro/frus_docs.RData")
clinton_docs<-db_docs('declassification_clinton') 
pdb_docs<-db_docs('declassification_pdb')
kissinger_docs<-db_docs('declassification_kissinger')
ddrs_docs<-db_docs('declassification_ddrs')
cabinet_docs<-db_docs('declassification_cabinet')
cpdoc_docs<-db_docs('declassification_cpdoc')
```

##Number of documents and date ranges for each collection
```{r}
#driver = dbDriver("MySQL")
#connection = dbConnect(driver,host='history-lab.org', password='XreadF403', user='de_reader')

db_doc_no_date <- function(mydb) {
#  mydb2 = dbConnect(driver,host='history-lab.org', password='XreadF403', user='de_reader', 
#                                      dbname=mydb)
mydb2<-eval(parse(text=paste(mydb, sep = "")), env=.GlobalEnv)
#docs<-tbl(mydb2, 'docs') %>% 
mydb2<-mydb2  %>%
  select(id, date) %>%
  collect() %>%
  distinct()
  
  return(c(nrow(mydb2), range(mydb2$date, na.rm = TRUE)))
}

db_doc_no_date('cables_docs')
db_doc_no_date('frus_docs')
db_doc_no_date('pdb_docs')
db_doc_no_date('kissinger_docs')
db_doc_no_date('clinton_docs') 
db_doc_no_date('ddrs_docs')
db_doc_no_date('cabinet_docs')
db_doc_no_date('cpdoc_docs')
```

##Frequency tables for full text vs. non-full text
```{r}

sum(!is.na(cables_docs$body))  
#sum(is.na(cables_docs$body[cables_docs$cable_type=="full"]))
#sum(is.na(cables_docs$body[cables_docs$cable_type=="preel"]))
#sum(is.na(cables_docs$body[cables_docs$cable_type=="preel_withdrawn"]))
#sum(is.na(cables_docs$body[cables_docs$cable_type=="withdrawn"]))
sum(!is.na(frus_docs$body))
sum(!is.na(pdb_docs$body))
sum(!is.na(kissinger_docs$body))
sum(!is.na(clinton_docs$body))
sum(is.na(ddrs_docs$body))
sum(!is.na(cabinet_docs$body))
sum(!is.na(cpdoc_docs$body))



sum(sum(!is.na(cables_docs$body)),
sum(!is.na(frus_docs$body)),
sum(!is.na(pdb_docs$body)),
sum(!is.na(kissinger_docs$body)),
sum(!is.na(clinton_docs$body)),
sum(is.na(ddrs_docs$body))#,
#sum(!is.na(cabinet_docs$body)),
#sum(!is.na(cpdoc_docs$body))
)

sum(sum(!is.na(cables_docs$body)),
sum(!is.na(frus_docs$body)),
sum(!is.na(pdb_docs$body)),
sum(!is.na(kissinger_docs$body)),
sum(!is.na(clinton_docs$body)),
sum(is.na(ddrs_docs$body)),
sum(!is.na(cabinet_docs$body)),
sum(!is.na(cpdoc_docs$body))
)

sum(is.na(cables_docs$body))
sum(is.na(frus_docs$body))
sum(is.na(pdb_docs$body))
sum(is.na(kissinger_docs$body))
sum(is.na(clinton_docs$body))
sum(!is.na(ddrs_docs$body))
sum(is.na(cabinet_docs$body))
sum(is.na(cpdoc_docs$body))

sum(sum(is.na(cables_docs$body)),
sum(is.na(frus_docs$body)),
sum(is.na(pdb_docs$body)),
sum(is.na(kissinger_docs$body)),
sum(is.na(clinton_docs$body)),
sum(!is.na(ddrs_docs$body))#,
#sum(is.na(cabinet_docs$body)),
#sum(is.na(cpdoc_docs$body))
)

sum(sum(is.na(cables_docs$body)),
sum(is.na(frus_docs$body)),
sum(is.na(pdb_docs$body)),
sum(is.na(kissinger_docs$body)),
sum(is.na(clinton_docs$body)),
sum(!is.na(ddrs_docs$body)),
sum(is.na(cabinet_docs$body)),
sum(is.na(cpdoc_docs$body)))
```

#Frequency tables for declassification_frus
##Number of Documents with Non-Missing Values by Variable
```{r}
setwd("/Users/clarahsuong/chronos_data_intro")

C1<-c("collection",
      "id",
      "body",
      "date",
      "classification",
      "volume_id",
      "chapt_title",
      "title", 
      #"subject",
      #"location", 
      "p_from",
      "p_to",
      "source"
)
  
C2<-c(sum(!is.na(frus_docs$collection)),
sum(!is.na(frus_docs$id)),
sum(!is.na(frus_docs$body)),
sum(!is.na(frus_docs$date)),
sum(!is.na(frus_docs$classification)),
sum(!is.na(frus_docs$volume_id)),
sum(!is.na(frus_docs$chapt_title)),
sum(!is.na(frus_docs$title)),
sum(!is.na(frus_docs$p_from)),
sum(!is.na(frus_docs$p_to)),
sum(!is.na(frus_docs$source))
)

table_frus_n_na<-cbind(C1, C2)
colnames(table_frus_n_na) <- c("Variable","Number of Documents with Non-Missing Values")

#htmlTable(ns,  
#          ctable=c("solid", "double"),
#          caption="Number of Documents with Non-Missing Values")

stargazer(table_frus_n_na,
          summary = FALSE,
          rownames = FALSE,
          type = "text", 
          title="Number of Documents with Non-Missing Values by Variable", 
          digits=1, 
          out="./data_analysis_output/table_frus_n_na.txt"
          )

stargazer(table_frus_n_na,
          summary = FALSE,
          rownames = FALSE,
          type = "html", 
          title="Number of Documents with Non-Missing Values by Variable", 
          digits=1, 
          out="./data_analysis_output/table_frus_n_na.html"
          )
```

##Number of Documents by Year
```{r}
setwd("/Users/clarahsuong/chronos_data_intro")

table_frus_n_year<-
  frus_docs %>%
  mutate(year=lubridate::year(date)) %>%
  group_by(year) %>%
  tally() %>%
  mutate(total_n = sum(n),
        rel.freq = paste0(round(100 * n/total_n, 2), "%")) %>%
  ungroup() %>% 
  adorn_totals("row")

stargazer(table_frus_n_year[c("year","n", "rel.freq")],
          summary = FALSE,
          rownames = FALSE,
          type = "text", 
          title="Number of Documents By Year", 
          digits=1, 
          out="./data_analysis_output/table_frus_n_year.txt",
          covariate.labels=c("Year","Number of Documents", "Relative Frequency")
          )

stargazer(table_frus_n_year[c("year","n", "rel.freq")],
          summary = FALSE,
          rownames = FALSE,
          type = "html", 
          title="Number of Documents By Year", 
          digits=1, 
          out="./data_analysis_output/table_frus_n_year.html",
          covariate.labels=c("Year","Number of Documents", "Relative Frequency")
          )
```
##Number of frus documents by year
```{r}
setwd("/Users/clarahsuong/chronos_data_intro")

frus_n_date<-
  frus_docs %>%
  dplyr::select(id, date, classification) %>%
  mutate(date=as_date(date), 
         Classification = replace_na(classification, "Missing"),
         year = as_date(cut(date, breaks = "year")))

png("./data_analysis_output/frus_n_year.png", width = 600, height = 450)
#layout(matrix(c(1:3), 3, 1,
# byrow = TRUE))
ggplot(frus_n_date, aes(year)) + 
  #geom_bar()
  geom_bar(aes(fill=Classification)) +
  scale_x_date(breaks=scales::pretty_breaks(10)) +
  scale_y_continuous(breaks=scales::pretty_breaks(10)) +
  labs(#title = "",
          #subtitle = "Data Plotted by Year",
           y = "Number of Documents",
           x = "Year") + 
  scale_fill_grey() +
  theme_bw() +
  theme(text = element_text(size=15),
        axis.text.x = element_text(size=11), 
        axis.text.y = element_text(size=11), 
        #legend.title=element_blank(), 
        legend.position = c(0.1, 0.9), 
        legend.justification = c(0.1, 0.9))
dev.off()
```

##Number of Documents by Classification
```{r}
setwd("/Users/clarahsuong/chronos_data_intro")

table_frus_n_class<-
  frus_docs %>%
  mutate(year=lubridate::year(date)) %>%
  group_by(classification) %>%
  tally() %>%
  mutate(total_n = sum(n),
        rel.freq = paste0(round(100 * n/total_n, 2), "%")) %>%
  ungroup() %>% 
  adorn_totals("row")

stargazer(table_frus_n_class[c("classification","n", "rel.freq")],
          summary = FALSE,
          rownames = FALSE,
          type = "text", 
          title="Number of Documents By Classification Level", 
          digits=1, 
          out="./data_analysis_output/table_frus_n_class.txt",
          covariate.labels=c("Classification","Number of Documents", "Relative Frequency"))

stargazer(table_frus_n_class[c("classification","n", "rel.freq")],
          summary = FALSE,
          rownames = FALSE,
          type = "html", 
          title="Number of Documents By Classification Level", 
          digits=1, 
          out="./data_analysis_output/table_frus_n_class.html",
          covariate.labels=c("Classification","Number of Documents", "Relative Frequency"))
```


#Frequency tables for declassification_cables
##Number of Documents with Non-Missing Values by Variable
```{r}
#driver = dbDriver("MySQL")
#connection = dbConnect(driver,host='history-lab.org', password='XreadF403', user='de_reader')
#mydb = dbConnect(driver,host='history-lab.org', password='XreadF403', user='de_reader', dbname='declassification_cables')

#cfpf_docs <- tbl(mydb,'docs') %>%
#  collect()
#save("/Users/clarahsuong/Dropbox/nyu_postdoc/ner/dataset_intro/cfpf_docs.RData")
#load("/Users/clarahsuong/Dropbox/nyu_postdoc/ner/dataset_intro/cfpf_docs.RData")
#Variables: subject; body; date; classification; from; to; tags; concepts; office
#cables_docs<-docs
setwd("/Users/clarahsuong/chronos_data_intro")

docs<-
  cables_docs %>%
  dplyr::select("collection",
      "id",
      "body",
      "date",
      "classification",
        "subject", 
                "from_field", 
                "to_field", 
                #"tags", 
                "concepts", 
                "office", 
                "handling", 
                "type") #%>%
  #mutate_each_(funs(factor),c("subject", "body", "date", "classification", "from_field", "to_field", 
  #              #"tags", 
  #              "concepts", "office", "handling"))

C1<-c("collection",
      "id",
      "body",
      "date",
      "classification",
      "subject", 
      "from_field", 
      "to_field", 
      #"tags", 
      "concepts", 
      "office", 
      "handling", 
      "type")
  
C2<-c(
sum(!is.na(docs$collection)),
sum(!is.na(docs$id)),
sum(!is.na(docs$body)),
sum(!is.na(docs$date)),
sum(!is.na(docs$classification)),
sum(!is.na(docs$subject)),
sum(!is.na(docs$from_field)),
sum(!is.na(docs$to_field)),
sum(!is.na(docs$concepts)),
sum(!is.na(docs$office)),
sum(!is.na(docs$type))
)

table_cables_n_na<-cbind(C1, C2)
colnames(table_cables_n_na) <- c("Variable","Number of Documents with Non-Missing Values")

#htmlTable(ns,  
#          ctable=c("solid", "double"),
#          caption="Number of Documents with Non-Missing Values")

stargazer(table_cables_n_na,
          summary = FALSE,
          rownames = FALSE,
          type = "text", 
          title="Number of Documents with Non-Missing Values by Variable", 
          digits=1, 
          out="./data_analysis_output/table_cables_n_na.txt"
          )

stargazer(table_cables_n_na,
          summary = FALSE,
          rownames = FALSE,
          type = "html", 
          title="Number of Documents with Non-Missing Values by Variable", 
          digits=1, 
          out="./data_analysis_output/table_cablse_n_na.html"
          )
```

##Number of Cables by Year
```{r}
setwd("/Users/clarahsuong/chronos_data_intro")

table_cables_n_year<-
  cables_docs %>%
  mutate(year=lubridate::year(date)) %>%
  group_by(year) %>%
  tally() %>%
  mutate(total_n = sum(n),
        rel.freq = paste0(round(100 * n/total_n, 2), "%")) %>%
  select(year, n, rel.freq) %>%
  adorn_totals("row")


stargazer(table_cables_n_year[c("year","n", "rel.freq")],
          summary = FALSE,
          rownames = FALSE,
          type = "text", 
          title="Number of Cables By Year", 
          digits=1, 
          out="./data_analysis_output/table_cables_n_year.txt",
          covariate.labels=c("Year","Number of Cables", "Relative Frequency")
          )

stargazer(table_cables_n_year[c("year","n", "rel.freq")],
          summary = FALSE,
          rownames = FALSE,
          type = "html", 
          title="Number of Cables By Year", 
          digits=1, 
          out="./data_analysis_output/table_cables_n_year.html",
          covariate.labels=c("Year","Number of Cables", "Relative Frequency")
          )
```

#Number of Cables by Classification
```{r}
setwd("/Users/clarahsuong/chronos_data_intro")

#driver = dbDriver("MySQL")
#connection = dbConnect(driver,host='history-lab.org', password='XreadF403', user='de_reader')
cables_db = dbConnect(driver,host='history-lab.org', password='XreadF403', user='de_reader', dbname='declassification_cables')

classification_doc2 <- tbl(cables_db,'classification_doc') %>%
  collect() %>%
  distinct() %>%
  group_by(classification_id) %>% 
  tally() %>% 
  ungroup() %>% 
  mutate(total_n = sum(n),
        rel.freq = paste0(round(100 * n/total_n, 2), "%"),
        classification=ifelse(classification_id==1,"Secret",
                              ifelse(classification_id==2,"Confidential", 
                                     ifelse(classification_id==5,"Unclassified",
                                            ifelse(classification_id==7,"Limited Official Use", NA)
                                            )
                                    )
                              )
        ) %>%
  select(classification, n, rel.freq) %>%
  adorn_totals("row")

#classification_doc=apply_labels(classification_doc,
#                                classification_id="Classification",
#                                classification_id=num_lab("1 Secret
#                                                          2 Confidential
#                                                          7 Limited Official Use
#                                                          5 Unclassified")
#                                )

#table_classification = fre(classification_doc$classification_id) %>% 
#  set_caption("Table: Documents by Classification") %>%
#  htmlTable()

stargazer(classification_doc2[c("classification","n", "rel.freq")],
          summary = FALSE,
          rownames = FALSE,
          type = "text", 
          title="Number of Documents By Classification Level", 
          digits=1, 
          out="./data_analysis_output/table_cables_n_class.txt",
          covariate.labels=c("Classification","Number of Documents", "Relative Frequency"))

stargazer(classification_doc2[c("classification","n", "rel.freq")],
          summary = FALSE,
          rownames = FALSE,
          type = "html", 
          title="Number of Documents By Classification Level", 
          digits=1, 
          out="./data_analysis_output/table_cables_n_class.html",
          covariate.labels=c("Classification","Number of Documents", "Relative Frequency"))

```
##Bar graph by month and classification
```{r}
setwd("/Users/clarahsuong/chronos_data_intro")

#driver = dbDriver("MySQL")
#connection = dbConnect(driver,host='history-lab.org', password='XreadF403', user='de_reader')
cables_db = dbConnect(driver,host='history-lab.org', password='XreadF403', user='de_reader', dbname='declassification_cables')

classification_doc3 <- tbl(cables_db,'classification_doc') %>%
  collect() %>%
  distinct() %>%
  mutate(
    date=as_date(date), 
    month = as_date(cut(date, breaks = "month")),
    classification=ifelse(classification_id==1,"Secret",
                              ifelse(classification_id==2,"Confidential", 
                                     ifelse(classification_id==5,"Unclassified",
                                            ifelse(classification_id==7,"Limited Official Use", NA)
                                            )
                                    )
                              )
        ) %>%
  select(classification, month) 

png("./data_analysis_output/table_cables_n_month_class.png", width = 600, height = 450)
ggplot(classification_doc3, aes(month)) + 
  geom_bar(aes(fill=classification)) +
  scale_x_date(breaks=scales::pretty_breaks(10)) +
  scale_y_continuous(breaks=scales::pretty_breaks(10)) +
  labs(#title = "",
          #subtitle = "Data Plotted by Year",
           y = "Number of Documents",
           x = "Month") + 
  scale_fill_grey() +
  theme_bw() +
  theme(text = element_text(size=15),
        axis.text.x = element_text(size=11), 
        axis.text.y = element_text(size=11), 
        legend.title=element_blank()#, 
        #legend.position = c(0.1, 0.9), 
        #legend.justification = c(0.1, 0.9)
        )
dev.off()
```

#Examine the different country codes across datasets
```{r}

setwd("/Users/clarahsuong/chronos_data_intro")

#Re-connect to the database
#driver = dbDriver("MySQL")
#connection = dbConnect(driver,host='history-lab.org', password='XreadF403', user='de_reader')
mydb = dbConnect(driver,host='history-lab.org', password='XreadF403', user='de_reader', dbname='declassification_cables')

#A list of countries according to our database
countries<-
  tbl(mydb, 'countries') %>% 
  collect() 
#This table is incomplete. Note that there is no tag for "South Vietnam" but tag "VM" (id: 557) for "Vietnam" according to this table. The 1976 TAGS manual lists VN (tag_id 1976) for "Viet-Nam (North)"and VS (tag_id 1973) for "Viet-Nam (South)". There is also no tag_id for Serbia, Montenegro, Croatia, Azerbaijan. 
#US is included.
#Note there is no tag_id for the Soviet Union but one for Russia.

#Merge ISO_3166_1 and ISO_3166_3 (ISO country codes for withdrawn countries). Note that this list often omits retired codes. 
iso_3166<-
  tibble::as_tibble(full_join(ISO_3166_1, ISO_3166_3, by = c("Alpha_3","Numeric","Name")))%>%
  mutate(Numeric=as.integer(Numeric)) %>%
  dplyr::select("Alpha_3",
         "Numeric",
         "Name",
         "Official_name",
         "Common_name") 

#Generate a dataframe for all (former and existing) countries according to COW. Note that this includes the US.
all_states<-
  read_csv("./external_data/cow/states2016.csv") %>%
  dplyr::select("stateabb","ccode","statenme") %>%
  #filter(!ccode==2) %>% #Leave out the US
  rename(cow_ccode=ccode,
         cow_stateabb=stateabb, 
         cow_statename=statenme) %>%   
  mutate(cow_stateabb=as.character(cow_stateabb),
         cow_statename=as.character(cow_statename)) %>%
  distinct() #There are duplicates. e.g. countries that existed, disappeared, and then re-appeared. 

#Generate a dataframe for all (former and existing) countries for years 1973-79. Note that this includes the US.
all_states_year<-
  all_states %>%
  rowr::cbind.fill(c(1973:1979),fill = NA) %>%
  rename(year=object) %>%
  expand(year = 1973:1979, nesting(cow_stateabb, 
                                   cow_ccode,                    
                                   cow_statename))

#Generate a dataframe for countries existing during the period of 1973-79. Note that the universe of countries differs by year due to the difference in countries' birth years. Note that this also includes the US.
states_70s_year<-
  read_csv("./external_data/cow/system2016.csv") %>%
  dplyr::select("stateabb","ccode","year") %>%
  filter(year>1972 & year<1980) %>%
  rename(cow_ccode=ccode, 
         cow_stateabb=stateabb) %>%
  left_join(all_states, by=c("cow_ccode","cow_stateabb")) #Include COW state names.

states_70s<-
  states_70s_year %>%
  dplyr::select(-year) %>%
  distinct() 
```

##Create a dataframe linking country codes and tag_ids
```{r}
#Re-connect to the database
#driver = dbDriver("MySQL")
#connection = dbConnect(driver,host='history-lab.org', password='XreadF403', user='de_reader')
#mydb = dbConnect(driver,host='history-lab.org', password='XreadF403', user='de_reader', dbname='declassification_cables')

#Note that this includes country codes and tag_id for the US.
country_code_tag<-
  tbl(mydb, 'countries') %>% 
  collect() %>%
  mutate(country_id=as.integer(id)) %>%
  dplyr::select(-id) %>%
  mutate(cow_ccode=countrycode(name, 'country.name', 'cown')) %>% #Derive COW country codes from the variable "name" in the table "countries."
  mutate(iso3n=countrycode(name, 'country.name', 'iso3n')) #Derive iso numeric country codes from the variable "name" in the table "countries."
  
#Check whether the variable "country_id" in the table "countries" is from ISO 3166.
#cow_ccode for Vietnam should be 816, not 817 (error in the package countrycode) and cow_ccode for West Germany (German Federal Republic) should be 260.
#iso3n for South Vietnam should not be 704 (country code of Vietnam) but 714 (error in the R package countrycode). The tag_id for South Vietnam is missing.
#country_code_tag$cowid2<-countrycode(country_code_tag$country_id, 'iso3n', 'cown')

all(country_code_tag$country_id %in% iso_3166$Numeric)
all(iso_3166$Numeric %in% country_code_tag$country_id)
setdiff(country_code_tag$country_id, iso_3166$Numeric)
country_code_tag[country_code_tag$country_id %in% setdiff(country_code_tag$country_id, iso_3166$Numeric),]
#Most of the items with a discrepancy between the database's country_id and iso-3166 numeric seem to be defunct states or non-state entities, except East and West Germany.

#Replace the wrong COW country codes and tag_id
country_code_tag<-
  country_code_tag %>%
  mutate(cow_ccode= replace(cow_ccode, name=="Vietnam", 816)) %>% #Fix cow_ccode for Vietnam 
  mutate(cow_ccode= replace(cow_ccode, name=="West Germany", 260)) %>% #Fix cow_ccode for West Germany (German Federal Republic) 
  mutate(tag_id=replace(tag_id, name=="South Vietnam", 1973)) %>% #Insert tag_id for South Vietnam
  rbind(c("Vietnam",
          0,
          1,
          1976,
          704,
          816,
          704
          )
        ) %>% #Insert the second tag_id value (1976) for Vietnam 
  mutate(cow_ccode=as.integer(cow_ccode),
         tag_id=as.integer(tag_id)) %>%
  inner_join(all_states, by="cow_ccode") %>% #Include state names from the COW list of all states that have ever existed.
  rename(country_name=name) %>% 
  filter(!is.na(cow_ccode) & !is.na(tag_id)) %>% #Drop the observations with missing COW country code and missing tag_id.
  dplyr::select(-iso3n) #Note the 2 tags for Vietnam.
```

#Tag traffic by country-year and by country

##Download, save, or load the tables for tags and docs (doc_id and date) in the working directory and count the number of cables tagged for each country
```{r results='hide'}

setwd("/Users/clarahsuong/chronos_data_intro")

#Re-connect to the database
#driver = dbDriver("MySQL")
#connection = dbConnect(driver,host='history-lab.org', password='XreadF403', user='de_reader')
#mydb = dbConnect(driver,host='history-lab.org', password='XreadF403', user='de_reader', dbname='declassification_cables')

tags<-
  tbl(mydb, 'tags') %>% 
  dplyr::select(id, tag, category) %>% collect() 

tag_doc<-
  tbl(mydb, 'tag_doc') %>% collect() #This table includes cables tagged with South Vietnam (tag_id 1973) and Vietnam (tag_id: 1976 and 557)
#tag_doc %>% filter(tag_id==1973)
#tag_doc %>% filter(tag_id==1976)
#tag_doc %>% filter(tag_id==557)

doc_date2<-
  tbl(mydb, 'docs') %>% 
  dplyr::select(id, date) %>%
  rename(doc_id=id) %>% collect()

country_tag_doc2<-
  tag_doc %>%
  inner_join(doc_date2, by = "doc_id") %>%
  inner_join(tags, by = c("tag_id"="id")) %>%
  inner_join(country_code_tag, by="tag_id") %>%
  mutate(year=lubridate::year(date), 
         month=lubridate::month(date), 
         date=lubridate::ymd(date), 
         ym=as.yearmon(paste(year, month),"%Y %m")
         ) 
#save(country_tag_doc2, file = "./data/country_tag_doc2.RData")
#load("./data/country_tag_doc2.RData")

cable_n_country_day<-
  country_tag_doc2 %>%
  group_by(.dots=c("cow_ccode", 
                   "cow_statename",
                   "country_id", 
                   "country_name", 
                   "date")) %>%
  tally() %>%
  ungroup()
#save(cable_n_country_day, file = "./data/cable_n_country_day.RData")
#load("./data/cable_n_country_day.RData") #Note that this includes neither all dates nor all countries on the COW list.

#The table country_doc attempts to add West Germany and South Vietnam based on regex matching in body.
#country_doc<-
#  tbl(mydb, 'country_doc') %>% collect()
#However, this table is also missing South Vietnam (country_id 714 or tag_id 1973). It seems to group (North) Vietnam and South Vietnam together, probably as a result of directly extracting Vietnam from the documents. The search in the table said there are 15,668 documents related to or tagged with Vietnam. 
#country_doc %>% filter(country_id==714)
#country_doc %>% filter(country_id==704)
#It is meaningful to distinguish cables related to South Vietnam from those about (North) Vietnam. Thus, do not use this table.

#Yearly tag traffic by state-year, including 0 cables by some countries that did not exist in the 1970s. Note that this does include the cables tagged with US. 
cable_n_all_states_year<-
  country_tag_doc2 %>%
  group_by(year, cow_ccode, cow_statename, cow_stateabb) %>%
  tally() %>%
  right_join(all_states_year, by=c("year", "cow_ccode", "cow_stateabb","cow_statename")) %>%
  rename(n_c_y=n) %>%
  mutate(n_c_y= replace(n_c_y, is.na(n_c_y), 0)) %>%
  ungroup() %>%
  mutate(total_n = sum(n_c_y)) %>%
  arrange(year, cow_ccode)
#save(cable_n_all_states_year, file = "./data/cable_n_all_states_year.RData")
#load("./data/cable_n_all_states_year.RData")

#Tag traffic by state, including 0 cables by some countries that did not exist in the 1970s. Note that this does include the cables tagged with US. 
cable_n_all_states<-
  country_tag_doc2 %>%
  group_by(cow_ccode, cow_statename, cow_stateabb) %>%
  tally() %>%
  right_join(all_states, by=c("cow_ccode", "cow_stateabb","cow_statename")) %>%
  rename(n_c=n) %>%
  mutate(n_c= replace(n_c, is.na(n_c), 0)) %>%
  ungroup() %>%
  mutate(total_n = sum(n_c)) %>%
  arrange(desc(n_c))
#save(cable_n_all_states, file = "./data/cable_n_all_states.RData")
#load("./data/cable_n_all_states.RData")

#Yearly tag traffic by state-year, excluding 0 cables by some countries that did not exist in the 1970s. Note that this does include the cables tagged with US. 
cable_n_states_70s_year<-
  country_tag_doc2 %>%
  group_by(year, cow_ccode, cow_statename, cow_stateabb) %>%
  tally() %>%
  right_join(states_70s_year, by=c("year", "cow_ccode", "cow_stateabb","cow_statename")) %>%
  rename(n_c_y=n) %>%
  mutate(n_c_y= replace(n_c_y, is.na(n_c_y), 0)) %>%
  ungroup() %>%
  mutate(total_n = sum(n_c_y)) %>%
  arrange(year, cow_ccode)
#save(cable_n_states_70s_year, file = "./data/cable_n_states_70s_year.RData")
#load("./data/cable_n_states_70s_year.RData")

#Tag traffic by state, excluding 0 cables by some countries that did not exist in the 1970s. Note that this does include the cables tagged with US. 
cable_n_states_70s<-
  country_tag_doc2 %>%
  group_by(cow_ccode, cow_statename, cow_stateabb) %>%
  tally() %>%
  right_join(states_70s, by=c("cow_ccode", "cow_stateabb","cow_statename")) %>%
  rename(n_c=n) %>%
  mutate(n_c= replace(n_c, is.na(n_c), 0)) %>%
  ungroup() %>%
  mutate(total_n = sum(n_c)) %>%
  arrange(desc(n_c))
#save(states_70s, file = "./data/cable_n_states_70s.RData")
#load("./data/cable_n_states_70s.RData")

#Note that the total ns for each dataset for differs a bit because: cable_n_states_70s and cable_n_states_70s_year look at only existing countries? or missing values?
```

##Examine cables tagged with certain countries as a test
```{r, echo=FALSE}
#Check tag_id for certain countries
country_code_tag%>%filter(str_detect(country_name, 'China'))
country_code_tag%>%filter(str_detect(country_name, 'Korea'))
country_code_tag%>%filter(str_detect(country_name, 'Viet'))
country_code_tag%>%filter(str_detect(country_name, 'Afghan'))
country_code_tag%>%filter(str_detect(country_name, 'Iran'))
country_code_tag%>%filter(str_detect(country_name, 'Germany'))
country_code_tag%>%filter(str_detect(country_name, 'Egypt'))

cable_china<-
  country_tag_doc2 %>%
  filter(tag_id==386) %>%
  group_by(date) %>%
  tally() 
  
cable_nkorea<-
  country_tag_doc2 %>%
  filter(tag_id==453)%>%
  group_by(date) %>%
  tally() 

cable_viet<-
  country_tag_doc2 %>%
  filter(tag_id==557 | tag_id==1976) %>%
  group_by(date) %>%
  tally() 

cable_s_viet<-
  country_tag_doc2 %>%
  filter(tag_id==1973) %>%
  group_by(date) %>%
  tally() 

cable_afghan<-
  country_tag_doc2 %>%
  filter(tag_id==342) %>%
  group_by(date) %>%
  tally()

cable_iran<-
  country_tag_doc2 %>%
  filter(tag_id==440) %>%
  group_by(date) %>%
  tally() 

cable_east_germany<-
  country_tag_doc2 %>%
  filter(tag_id==419) %>%
  group_by(date) %>%
  tally() 

cable_egypt<-
  country_tag_doc2 %>%
  filter(tag_id==402) %>%
  group_by(date) %>%
  tally() 
```


##Summary statistics of tag traffic by country-year and by country
```{r}
setwd("/Users/clarahsuong/chronos_data_intro")

#Country-year level
stargazer(as.data.frame(cable_n_all_states_year)[c("year", "cow_ccode", "n_c_y")], 
          type = "text", 
          title="Summary Statistics of Tag Traffic by Country-Year (Incl. Former Countries)", 
          digits=1, 
          out="./data_analysis_output/desc_cable_n_all_states_year.txt",
          covariate.labels=c("Year", "COW Codes of Countries Tagged in Cables", "Tag Traffic for Each Country-Year"))

stargazer(as.data.frame(cable_n_all_states_year)[c("year", "cow_ccode", "n_c_y")], 
          type = "html", 
          title="Summary Statistics of Tag Traffic by Country-Year (Incl. Former Countries)", 
          digits=1, 
          out="./data_analysis_output/desc_cable_n_all_states_year.html",
          covariate.labels=c("Year", "COW Codes of Countries Tagged in Cables", "Tag Traffic for Each Country-Year"))

stargazer(as.data.frame(cable_n_states_70s_year)[c("year", "cow_ccode", "n_c_y")], 
          type = "text", 
          title="Summary Statistics of Tag Traffic by Country-Year (Only Existing Countries)", 
          digits=1, 
          out="./data_analysis_output/desc_cable_n_states_70s_year.txt",
          covariate.labels=c("Year", "COW Codes of Countries Tagged in Cables", "Tag Traffic for Each Country-Year"))

stargazer(as.data.frame(cable_n_states_70s_year)[c("year", "cow_ccode", "n_c_y")], 
          type = "html", 
          title="Summary Statistics of Tag Traffic by Country-Year (Only Existing Countries)", 
          digits=1, 
          out="./data_analysis_output/desc_cable_n_states_70s_year.html",
          covariate.labels=c("Year", "COW Codes of Countries Tagged in Cables", "Tag Traffic for Each Country-Year"))

stargazer(as.data.frame(cable_n_states_70s_year[cable_n_states_70s_year$cow_ccode!=2,])[c("year", "cow_ccode", "n_c_y")], 
          type = "text", 
          title="Summary Statistics of Tag Traffic by Country-Year (Only Existing Non-US Countries)", 
          digits=1, 
          out="./data_analysis_output/desc_cable_n_nonus_states_70s_year.txt",
          covariate.labels=c("Year", "COW Codes of Countries Tagged in Cables", "Tag Traffic for Each Country-Year"))

stargazer(as.data.frame(cable_n_states_70s_year[cable_n_states_70s_year$cow_ccode!=2,])[c("year", "cow_ccode", "n_c_y")], 
          type = "html", 
          title="Summary Statistics of Tag Traffic by Country-Year (Only Existing Non-US Countries)", 
          digits=1, 
          out="./data_analysis_output/desc_cable_n_nonus_states_70s_year.html",
          covariate.labels=c("Year", "COW Codes of Countries Tagged in Cables", "Tag Traffic for Each Country-Year"))


#Country level
stargazer(as.data.frame(cable_n_all_states)[c("cow_ccode", "n_c")], 
          type = "text", 
          title="Summary Statistics of Tag Traffic by Country (Incl. Former Countries)", 
          digits=1, 
          out="./data_analysis_output/desc_cable_n_all_states.txt",
          covariate.labels=c("COW Codes of Countries Tagged in Cables", "Tag Traffic for Each Country"))

stargazer(as.data.frame(cable_n_all_states)[c("cow_ccode", "n_c")], 
          type = "html", 
          title="Summary Statistics of Tag Traffic by Country (Incl. Former Countries)", 
          digits=1, 
          out="./data_analysis_output/desc_cable_n_all_states.html",
          covariate.labels=c("COW Codes of Countries Tagged in Cables", "Tag Traffic for Each Country"))

stargazer(as.data.frame(cable_n_states_70s)[c("cow_ccode", "n_c")], 
          type = "text", 
          title="Summary Statistics of Tag Traffic by Country (Incl. Only Existing Countries)", 
          digits=1, 
          out="./data_analysis_output/desc_cable_n_states_70s.txt",
          covariate.labels=c("COW Codes of Countries Tagged in Cables", "Tag Traffic for Each Country"))

stargazer(as.data.frame(cable_n_states_70s)[c("cow_ccode", "n_c")],
          type = "html", 
          title="Summary Statistics of Tag Traffic by Country (Incl. Only Existing Countries)",
          digits=1, 
          out="./data_analysis_output/desc_cable_n_states_70s.html",
          covariate.labels=c("COW Codes of Countries Tagged in Cables", "Tag Traffic for Each Country"))

stargazer(as.data.frame(cable_n_states_70s[cable_n_states_70s$cow_ccode!=2,])[c("cow_ccode", "n_c")], 
          type = "text", 
          title="Summary Statistics of Tag Traffic by Country (Incl. Only Existing Non-US Countries)", 
          digits=1, 
          out="./data_analysis_output/desc_cable_n_nonus_states_70s.txt",
          covariate.labels=c("COW Codes of Countries Tagged in Cables", "Tag Traffic for Each Country"))

stargazer(as.data.frame(cable_n_states_70s[cable_n_states_70s$cow_ccode!=2,])[c("cow_ccode", "n_c")],
          type = "html", 
          title="Summary Statistics of Tag Traffic by Country (Incl. Only Existing Non-US Countries)",
          digits=1, 
          out="./data_analysis_output/desc_cable_n_nonus_states_70s.html",
          covariate.labels=c("COW Codes of Countries Tagged in Cables", "Tag Traffic for Each Country"))

```

##Histograms and density plots
```{r}
setwd("/Users/clarahsuong/chronos_data_intro")

plot(density(cable_n_states_70s_year$n_c_y))
plot(density(cable_n_states_70s$n_c))
#The distribution for the count variables is right skewed. Convert the raw number of cables to a 0-1 index???  

#Main plot for tag traffic
options(scipen=10000000)
png("./data_analysis_output/cable_n_c_y_c_hist.png")
layout(matrix(c(1:2), 2, 1,
 byrow = TRUE))
hist(cable_n_states_70s_year[cable_n_states_70s_year$cow_ccode!=2,]$n_c_y, # histogram
 #col = "peachpuff", # column color
 border = "black",
 prob = TRUE, # show densities instead of frequencies
 ylim = c(0, 0.0004),
 xlab = "Tag Traffic",
 main = "Existing Non-US Country-Years")
lines(density(cable_n_states_70s_year[cable_n_states_70s_year$cow_ccode!=2,]$n_c_y), # density plot
 lwd = 2, # thickness of line
 col = "chocolate3")
hist(cable_n_states_70s[cable_n_states_70s$cow_ccode!=2,]$n_c, # histogram
 #col = "peachpuff", # column color
 border = "black",
 prob = TRUE, # show densities instead of frequencies
 #xlim = c(0, 20000), 
  ylim = c(0, 0.0001),
 xlab = "Tag Traffic",
 main = "Existing Non-US Countries")
lines(density(cable_n_states_70s[cable_n_states_70s$cow_ccode!=2,]$n_c), # density plot
 lwd = 2, # thickness of line
 col = "chocolate3")
dev.off()

#Country-year level
options(scipen=10000000)
png("./data_analysis_output/cable_n_states_year_hist.png")
layout(matrix(c(1:2), 2, 1,
 byrow = TRUE))
hist(cable_n_all_states_year$n_c_y, # histogram
 #col = "peachpuff", # column color
 border = "black",
 prob = TRUE, # show densities instead of frequencies
 ylim = c(0, 0.0004),
 xlab = "Tag Traffic",
 main = "All Country-Years")
lines(density(cable_n_all_states_year$n_c_y), # density plot
 lwd = 2, # thickness of line
 col = "chocolate3")
hist(cable_n_states_70s_year$n_c_y, # histogram
 #col = "peachpuff", # column color
 border = "black",
 prob = TRUE, # show densities instead of frequencies
 ylim = c(0, 0.0004),
 xlab = "Tag Traffic",
 main = "Existing Country-Years")
lines(density(cable_n_states_70s_year$n_c_y), # density plot
 lwd = 2, # thickness of line
 col = "chocolate3")
#hist(cable_n_states_70s_year[cable_n_states_70s_year$cow_ccode!=2,]$n_c_y, # histogram
# #col = "peachpuff", # column color
# border = "black",
# prob = TRUE, # show densities instead of frequencies
# ylim = c(0, 0.0004),
# xlab = "Tag Traffic",
# main = "Existing Non-US Country-Years")
#lines(density(cable_n_states_70s_year[cable_n_states_70s_year$cow_ccode!=2,]$n_c_y), # density plot
# lwd = 2, # thickness of line
# col = "chocolate3")
dev.off()

#Country level
png("./data_analysis_output/cable_n_states_hist.png")
layout(matrix(c(1:2), 2, 1,
 byrow = TRUE))
hist(cable_n_all_states$n_c, # histogram
 #col = "peachpuff", # column color
 border = "black",
 prob = TRUE, # show densities instead of frequencies
 #xlim = c(0, 20000), 
  ylim = c(0, 0.0001),
 xlab = "Tag Traffic",
 main = "All Countries")
lines(density(cable_n_all_states$n_c), # density plot
 lwd = 2, # thickness of line
 col = "chocolate3")
hist(cable_n_states_70s$n_c, # histogram
 #col = "peachpuff", # column color
 border = "black",
 prob = TRUE, # show densities instead of frequencies
 #xlim = c(0, 20000), 
  ylim = c(0, 0.0001),
 xlab = "Tag Traffic",
 main = "Existing Countries")
lines(density(cable_n_states_70s$n_c), # density plot
 lwd = 2, # thickness of line
 col = "chocolate3")
#hist(cable_n_states_70s[cable_n_states_70s$cow_ccode!=2,]$n_c, # histogram
# #col = "peachpuff", # column color
# border = "black",
# prob = TRUE, # show densities instead of frequencies
# #xlim = c(0, 20000), 
#  ylim = c(0, 0.0001),
# xlab = "Tag Traffic",
# main = "Existing Non-US Countries")
#lines(density(cable_n_states_70s[cable_n_states_70s$cow_ccode!=2,]$n_c), # density plot
# lwd = 2, # thickness of line
# col = "chocolate3")
dev.off()
```

##Non-US country-years with most cables
```{r}
setwd("/Users/clarahsuong/chronos_data_intro")

table_state_year_top20<- 
  cable_n_states_70s_year %>%
  filter(cow_ccode!=2) %>%
  mutate(rel.freq = paste0(round(100 * n_c_y/total_n, 2), "%")) %>%
  arrange(desc(n_c_y)) %>%
  top_n(n = 20, wt = n_c_y) %>%
  mutate(cow_statename= replace(cow_statename, cow_statename=="Russia", "Soviet Union")) #Replace "Russia" with "Soviet Union"

stargazer(table_state_year_top20[c("year", "cow_statename", "n_c_y","rel.freq")],
          summary = FALSE,
          rownames = FALSE,
          type = "text", 
          title="Non-US Country-Years with Highest Tag Traffic", 
          digits=1, 
          out="./data_analysis_output/top20_cable_n_state_year.txt",
          covariate.labels=c("Year","Tagged Country", "Number of Cables", "Relative Frequency"))

stargazer(table_state_year_top20[c("year", "cow_statename", "n_c_y","rel.freq")],
          summary = FALSE,
          rownames = FALSE,
          type = "html", 
          title="Non-US Country-Years with Highest Tag Traffic", 
          digits=1, 
          out="./data_analysis_output/top20_cable_n_state_year.html",
          covariate.labels=c("Year","Tagged Country", "Number of Cables", "Relative Frequency"))
```

##Non-US country-years with fewest cables
```{r}
setwd("/Users/clarahsuong/chronos_data_intro")

table_state_year_bottom10<- 
  cable_n_states_70s_year %>%
  filter(cow_ccode!=2) %>%
  mutate(rel.freq = paste0(round(100 * n_c_y/total_n, 2), "%")) %>%
  arrange(desc(n_c_y)) %>%
  top_n(n = -10, wt = n_c_y) %>%
  mutate(cow_statename= replace(cow_statename, cow_statename=="Russia", "Soviet Union")) #Replace "Russia" with "Soviet Union"


stargazer(table_state_year_bottom10[c("year", "cow_statename", "n_c_y","rel.freq")],
          summary = FALSE,
          rownames = FALSE,
          type = "text", 
          title="Non-US Country-Years with Lowest Tag Traffic", 
          digits=2, 
          out="./data_analysis_output/bottom10_cable_n_state_year.txt",
          covariate.labels=c("Year","Tagged Country", "Number of Cables", "Relative Frequency"))

stargazer(table_state_year_bottom10[c("year", "cow_statename", "n_c_y","rel.freq")],
          summary = FALSE,
          rownames = FALSE,
          type = "html", 
          title="Non-US Country-Years with Lowest Tag Traffic", 
          digits=2, 
          out="./data_analysis_output/bottom10_cable_n_state_year.html",
          covariate.labels=c("Year","Tagged Country", "Number of Cables", "Relative Frequency"))
```


##Countries most frequently tagged in cables
```{r}
setwd("/Users/clarahsuong/chronos_data_intro")

table_state_top20<- 
  cable_n_states_70s %>%
  filter(cow_ccode!=2) %>%
  #group_by(cow_ccode, cow_stateabb, cow_statename) %>% 
  #summarise(n_c = sum(n_c)) %>%
  #ungroup %>%
  mutate(rel.freq = paste0(round(100 * n_c/total_n, 2), "%")) %>%
  arrange(desc(n_c)) %>%
  top_n(n = 20, wt = n_c) %>%
  mutate(cow_statename= replace(cow_statename, cow_statename=="Russia", "Soviet Union")) #Replace "Russia" with "Soviet Union"


stargazer(table_state_top20[c("cow_statename", "n_c","rel.freq")],
          summary = FALSE,
          rownames = FALSE,
          type = "text", 
          title="Non-US Countries Most Frequently Tagged in Cables", 
          digits=1, 
          out="./data_analysis_output/top20_cable_n_state.txt",
          covariate.labels=c("Country", "Number of Cables", "Relative Frequency"))

stargazer(table_state_top20[c("cow_statename", "n_c","rel.freq")],
          summary = FALSE,
          rownames = FALSE,
          type = "html", 
          title="Non-US Countries Most Frequently Tagged in Cables", 
          digits=1, 
          out="./data_analysis_output/top20_cable_n_state.html",
          covariate.labels=c("Country", "Number of Cables", "Relative Frequency"))
```

##Non-U.S. countries least frequently tagged in cables
```{r}
setwd("/Users/clarahsuong/chronos_data_intro")

table_state_bottom10<- 
  cable_n_states_70s %>%
  filter(cow_ccode!=2) %>%
  mutate(rel.freq = paste0(round(100 * n_c/total_n, 0), "%")) %>%
  arrange(desc(n_c)) %>%
  top_n(n = -10, wt = n_c) %>%
  mutate(cow_statename= replace(cow_statename, cow_statename=="Russia", "Soviet Union")) #Replace "Russia" with "Soviet Union"


stargazer(table_state_bottom10[c("cow_statename", "n_c","rel.freq")],
          summary = FALSE,
          rownames = FALSE,
          type = "text", 
          title="Non-US Countries Least Frequently Tagged in Cables", 
          digits=1, 
          out="./data_analysis_output/bottom10_cable_n_state.txt",
          covariate.labels=c("Country", "Number of Cables", "Relative Frequency"))

stargazer(table_state_bottom10[c("cow_statename", "n_c","rel.freq")],
          summary = FALSE,
          rownames = FALSE,
          type = "html", 
          title="Non-US Countries Least Frequently Tagged in Cables", 
          digits=1, 
          out="./data_analysis_output/bottom10_cable_n_state.html",
          covariate.labels=c("Country", "Number of Cables", "Relative Frequency"))
```

##Plot of tag traffic of top countries
###Line graph
```{r}
setwd("/Users/clarahsuong/chronos_data_intro")

coi_10_list<-table_state_top20$cow_ccode[1:10]

coi_10<-
  cable_n_country_day %>%
  filter(cow_ccode %in% coi_10_list) %>%
    mutate(year=lubridate::year(date), 
         month=lubridate::month(date), 
         ym=as.yearmon(paste(year, month),"%Y %m")
         ) %>%
  group_by(cow_ccode, cow_statename, country_id, country_name, month, year) %>%
  summarise(sum_monthly = sum(n)) %>%
  ungroup() %>%
  mutate(month2 = as.Date(paste0(year,"-", month,"-01"),"%Y-%m-%d")) %>%
  mutate(cow_statename= replace(cow_statename, cow_statename=="Russia", "Soviet Union"), #Replace "Russia" with "Soviet Union"
        cow_statename= replace(cow_statename, cow_statename=="German Democratic Republic", "East Germany"))

png("./data_analysis_output/key10.png", width = 600, height = 450)
ggplot(coi_10, aes(x = month2, y = sum_monthly)) + 
  geom_line(aes(linetype = cow_statename), size = 1) +
  scale_x_date(breaks=scales::pretty_breaks(10)) +
  scale_y_continuous(breaks=scales::pretty_breaks(10)) +
  labs(y = "Country Tag Traffic Volume",
       x = "Month") + 
  scale_fill_grey() +
  theme_bw() +
  theme(text = element_text(size=15),
        axis.text.x = element_text(size=11), 
        axis.text.y = element_text(size=11), 
        legend.title=element_blank(), 
        legend.position = c(0.95, 0.05), 
        legend.justification = c(0.95, 0.05)
        )
dev.off()
```

###Bar graph
```{r}
setwd("/Users/clarahsuong/chronos_data_intro")

coi_5_list<-table_state_top20$cow_ccode[1:5]

coi_5<-
  country_tag_doc2  %>%
  filter(cow_ccode %in% coi_5_list) %>%
  mutate(cow_statename= replace(cow_statename, cow_statename=="Russia", "Soviet Union"),
         cow_statename= replace(cow_statename, cow_statename=="German Democratic Republic", "East Germany"), 
        #cow_statename2=ifelse(cow_ccode %in% coi_5_list, cow_statename, "Other"),
        date=as_date(date),          
        month = as_date(cut(date, breaks = "month")))

png("./data_analysis_output/key5.png", width = 600, height = 450)
ggplot(coi_5, aes(month)) + 
  geom_bar(aes(fill=cow_statename)) +
  scale_x_date(breaks=scales::pretty_breaks(10)) +
  scale_y_continuous(breaks=scales::pretty_breaks(10)) +
  labs(y = "Country Tag Traffic Volume",
       x = "Month") + 
  scale_fill_grey() +
  theme_bw() +
  theme(text = element_text(size=15),
        axis.text.x = element_text(size=11), 
        axis.text.y = element_text(size=11), 
        legend.title=element_blank()#, 
        #legend.position = c(0.95, 0.05), 
        #legend.justification = c(0.95, 0.05)
        )
dev.off()
```

###Country tag traffic vs. cable traffic
```{r}
setwd("/Users/clarahsuong/chronos_data_intro")

#Re-connect to the database
driver = dbDriver("MySQL")
connection = dbConnect(driver,host='history-lab.org', password='XreadF403', user='de_reader')
mydb = dbConnect(driver,host='history-lab.org', password='XreadF403', user='de_reader', dbname='declassification_cables')

network_docs_date2 <-
  tbl(mydb, 'network_docs') %>% 
  collect() %>%
  inner_join(doc_date2, by=c("id"="doc_id"))

moscow<-
  network_docs_date2 %>% 
  filter(node_a=="MOSCOW" | node_b=="MOSCOW") %>%
  mutate(year=lubridate::year(date)) %>%
  group_by(year) %>%
  tally()

russia_tag<-
  cable_n_states_70s_year %>%
  filter(cow_statename=="Russia")

russia_tag_network<-cbind(russia_tag[c("year", "n_c_y")], moscow["n"])
colnames(russia_tag_network) <- c("Year","Tag Traffic", "Cable Traffic")

stargazer(russia_tag_network,
          type = "html", 
          #flip = TRUE,
          summary = FALSE,
          rownames = FALSE,
          title="Comparison of Tag Traffic and Cable Traffic", 
          digits=1, 
          out="./data_analysis_output/russia_tag_network.html",
          covariate.labels=c("Year", "Number of Cables Tagged<br>with the USSR", "Number of Cables Sent by/to<br>the US Embassy in Moscow")
          )
  
stargazer(russia_tag_network,
          type = "text", 
          #flip = TRUE,
          summary = FALSE,
          rownames = FALSE,
          title="Comparison of Tag Traffic and Cable Traffic", 
          digits=1, 
          out="./data_analysis_output/russia_tag_network.txt",
          covariate.labels=c("Year", "Number of Cables Tagged with the USSR", "Number of Cables Sent by/to the US Embassy in Moscow")
          )
```
#Iran
```{r}
setwd("/Users/clarahsuong/chronos_data_intro")

#Re-connect to the database
driver = dbDriver("MySQL")
connection = dbConnect(driver,host='history-lab.org', password='XreadF403', user='de_reader')
mydb = dbConnect(driver,host='history-lab.org', password='XreadF403', user='de_reader', dbname='declassification_cables')

iran_tag<-
  cable_n_states_70s_year %>%
  filter(cow_statename=="Iran")

iran_tag
```

#U.S. diplomatic representation

##Import and load the COW data for U.S. diplomatic representation
```{r echo=FALSE}
setwd("/Users/clarahsuong/chronos_data_intro")

us_dip_rep_cow<-
  read_csv("./external_data/cow/Diplomatic_Exchange_2006v1.csv") %>%
  filter(1972<year & year<1980) %>%
  filter(ccode1==2) %>%
  dplyr::select("ccode2","year","DR_at_2","DE")
```

##Import and load the Moyer data for U.S. diplomatic representation
```{r}
setwd("/Users/clarahsuong/chronos_data_intro")

us_dip_rep_moyer<-
  read_csv("./external_data/moyer_et_al_2016/Pardee Center Diplomatic Representation_COW 20190208.csv") %>% #COW-compatible version
#  read_excel("../external_data/moyeretal2016/Diplomatic_Exchange_V3.16.16.xlsx") %>% #Non-compatible, public version
  mutate(Year=as.numeric(Year)) %>%
  rename(year = Year) %>%
  filter(Country=="United States of America") %>%
  mutate(cow_ccode=countrycode(Destination, 'country.name', 'cown')) %>% 
  #COW country code for German Federal Republic is wrong and should be 260, not 255. This is an error in the R package countrycode. Note that the dataset is also missing observation for U.S. embassies in South Vietnam and the Bahamas. 
  mutate(cow_ccode= replace(cow_ccode, Destination=="German Federal Republic", 260)) %>%
  right_join(states_70s_year, by=c("year", "cow_ccode")) %>% #Note the missing values for Destination but not cow_ccode. This also includes the U.S.
  arrange(cow_ccode, year) %>%
  #mutate(date = ymd(paste0(year, "-", 06, "-", 01))) %>%
  mutate(dip_rep_m=ifelse(is.na(`Embassy Old`),0, 1)) %>% #Created a variable for US representation. The dataset by Arias and Smith 2018 seems more accurate. This dataset misses the case of U.S. embassy in the Bahamas in 1973-75 wherease the latter includes it.
  rename(dip_focus=`Focus New`) %>%
  mutate(dip_focus=replace(dip_focus, dip_rep_m==0, 0)) %>%
  dplyr::select(cow_ccode, year, dip_rep_m, dip_focus)
#The codebook is outdated and omits important information. It seems like the value 0 for the variable "Focus New" represents unreciprocated cases.   
#sum(is.na(us_dip_rep_moyer$`Embassy Old`)) is the same as:
#sum(is.na(us_dip_rep_moyer$`Focus New`))
```

```{r, echo=FALSE}
#Examine some countries
us_dip_rep_china<-
  filter(us_dip_rep_moyer, cow_ccode==710) %>%
  mutate(dip_rep=ifelse(`Embassy New`==6,1, NA))

#Note that the dataset is inaccurately referring to South Vietnam as Vietnam.
#us_dip_rep_viet<-
#  filter(us_dip_rep2, cow_ccode==816) %>%
#  mutate(dip_rep=ifelse(`Embassy New`==6,1, NA))

us_dip_rep_iran<-
  filter(us_dip_rep_moyer, cow_ccode==630) %>%
  mutate(dip_rep=ifelse(`Embassy New`==6,1, NA))

us_dip_rep_afghan<-
  filter(us_dip_rep_moyer, cow_ccode==700) %>%
  mutate(dip_rep=ifelse(`Embassy New`==6,1, NA))

#No diplomatic relations between the U.S. and (North) Vietnam until 1995
#No formal relations between the U.S. and North Korea
```

##Import Arias and Smith's data on diplomatic appointment and representation
```{r}  
setwd("/Users/clarahsuong/chronos_data_intro")

#Save the dta file as a csv file and read in the csv file
#write.csv(read.dta("./external_data/arias_smith_2018/ambassadors.dta"),"../external_data/arias_smith_2018/ambassadors.csv")

us_dip_rep_app <-  
  read_csv("./external_data/arias_smith_2018/ambassadors.csv", guess_max = 100000) %>%
  dplyr::select(year, ccode, country_ambassador, ambassador, position, politicalappointee,
                performanceMU,good, bad, nationrank) %>%
  rename(cow_ccode=ccode, ambassador_name=ambassador) %>%
  mutate(dip_rep_a=ifelse(is.na(country_ambassador),0, 1)) %>% #Created a variable for inferred US representation. Check this variable against the dataset by Moyer 2016. There may be a discrepancy due to bureaucratic delays and so on. For instance, there may be a diplomatic relationship but there is a delay in confirming him/her and the DCM serves as CM instead. 
  mutate(ambassador=ifelse(position=="Ambassador Extraordinary and Plenipotentiary",1, 0)) %>%
  group_by(year, cow_ccode) %>%
  summarise(dip_rep_a=max(dip_rep_a, na.rm = TRUE),
            nationrank=mean(nationrank, na.rm = TRUE),
            politicalappointee_year=mean(politicalappointee, na.rm = TRUE),
            performanceMU_year=mean(performanceMU, na.rm = TRUE),
            ambassador_year=mean(ambassador, na.rm = TRUE)
            ) %>%
  ungroup() %>%
  right_join(states_70s_year, by=c("cow_ccode", "year")) %>%  
  mutate(dip_rep_a=replace(dip_rep_a, is.na(dip_rep_a), 0)) 
```

#U.S. Diplomatic Visits

##Import and load the data on U.S. diplomatic visits
```{r}
setwd("/Users/clarahsuong/chronos_data_intro")

#Save the dta file as a csv file
#write.csv(read.dta("diplomatic_core.replication.dta"),"./external_data/lebovic_saunders_2016/diplomatic_core.replication.csv")

us_dip_vis<-
  read_csv("./external_data/lebovic_saunders_2016/diplomatic_core.replication.csv") %>%
  dplyr::select(cowid, year, bi_PRE, bi_SOS) %>%#, mil_ratio, USmilaid, allies, USdefense, USdefense_EUR, UStrade, energypc, USalign, UNpart, mpower, term2, NIX, FOR, CAR, demo, bi_L1_PRE, EUR, AFR, MEA, SCA, EAP, bi_L14_SOS, bi_L14_PRE, bi_L58_SOS, bi_L58_PRE) %>%
  rename(cow_ccode=cowid) %>%
  right_join(states_70s_year, by=c("cow_ccode", "year"))  
  #mutate(un_member= ifelse(!is.na(UNpart),1, NA)) #Check whether newly admitted states participate in UN voting only the year after

#a<-us_dip_vis[us_dip_vis$UNpart==0,]

#Note that the paper (LEBOVIC AND SAUNDERS 2016) mentions the variable for crisis (Crisis Shocks from the International Crisis Behavior Project) but the dataset actually does not include it. The paper notes that "regularized patterns [of U.S. diplomatic visits] that we discern are not products of crisis diplomacy and that crises do not strongly affect the results" (p.119).
#This dataset includes country code 818 but none of the COW country datasets include it. Drop the row with cow_ccode=818.
#It also includes 0s for countries non-existent in the 1970s as a potential diplomatic partner (e.g. Croatia with country code 344 and Bosnia and Herzegovina with country code 346).
```

##Examine cables tagged with certain countries as a test
```{r}

us_dip_vis_china<-
  filter(us_dip_vis, cowid==710)

us_dip_vis_nkorea<-
  filter(us_dip_vis, cowid==731)

us_dip_vis_viet<-
  filter(us_dip_vis, cowid==816)

us_dip_vis_iran<-
  filter(us_dip_vis, cowid==630)

us_dip_vis_afghan<-
  filter(us_dip_vis, cowid==700)

us_dip_vis_egypt<-
  filter(us_dip_vis, cowid==651)

us_dip_vis_east_germany<-
  filter(us_dip_vis, cowid==265)
```

#U.S. Diplomatic Events

#Import and load the data on US diplomatic events
```{r results="hide"}
setwd("/Users/clarahsuong/chronos_data_intro")

us_dip_evt<-
  read_csv("./external_data/carter_2018/AmericanDiplomacyDataset.csv") 

#Check whether the country abbreviations are from COW or ISO-3166.
all(us_dip_evt$source %in% country_code_tag$cow_stateabb)
all(us_dip_evt$target %in% country_code_tag$cow_stateabb)
all(us_dip_evt$source %in% iso_3166$Alpha_3)
all(us_dip_evt$target %in% iso_3166$Alpha_3)

setdiff(us_dip_evt$source, country_code_tag$cow_stateabb)
setdiff(us_dip_evt$target, country_code_tag$cow_stateabb)
setdiff(us_dip_evt$source, iso_3166$Alpha_3)
setdiff(us_dip_evt$target, iso_3166$Alpha_3)

all(setdiff(us_dip_evt$target, iso_3166$Alpha_3) %in% us_dip_evt$target)
all(setdiff(us_dip_evt$source, iso_3166$Alpha_3) %in% us_dip_evt$source)
all(setdiff(us_dip_evt$target, iso_3166$Alpha_3) %in% iso_3166$Alpha_3)
all(setdiff(us_dip_evt$source, iso_3166$Alpha_3) %in% iso_3166$Alpha_3)

us_dip_evt[us_dip_evt$target %in% setdiff(us_dip_evt$target, iso_3166$Alpha_3),]
us_dip_evt[us_dip_evt$source %in% setdiff(us_dip_evt$source, iso_3166$Alpha_3),]

#It looks like the variables "target" and "source" in the dataset are "the 2-character FIPS10-4 country code for the location" (http://data.gdeltproject.org/documentation/ISA.2013.GDELT.pdf). But these seem to overlap a lot with iso3c

#Entities with missing COW country codes are non-state. Let's drop or fix them.
#table(us_dip_evt[is.na(us_dip_evt$cow_ccode_source),]$source)
#table(us_dip_evt[is.na(us_dip_evt$cow_ccode_target),]$target)
#AUH: Abu Dhabi before it became part of UAE in December 1971. 
#BMU: Bermuda
#CYM: Cayman Islands 
#HKG: Hong Kong before it became part of China in 1997
#PSE: Palestine
#SER: Yugoslavia? (https://wits.worldbank.org/wits/wits/witshelp/content/codes/country_codes.htm)
#TBT: Tibet (Dalai Lama visited the US on Sep.3-Oct.21, 1979 (https://www.dalailama.com/the-dalai-lama/events-and-awards/travels/travels-1959-1979).)  
#TMP: East Timor (https://wits.worldbank.org/wits/wits/witshelp/content/codes/country_codes.htm)
#VMN: a typo for VNM (Vietnam)? 
#YUG: Transitional reservations for former Yugoslavia/Serbia and Montenegro (https://en.wikipedia.org/wiki/ISO_3166-1_alpha-3 https://wits.worldbank.org/wits/wits/witshelp/content/codes/country_codes.htm)

us_dip_evt<-
  read_csv("./external_data/carter_2018/AmericanDiplomacyDataset.csv") %>%
  #filter(1969<year & year<1981) %>%
  mutate(cow_ccode_source=countrycode(source, 'iso3c','cown'),
       cow_ccode_target=countrycode(target, 'iso3c','cown')) %>%
#  mutate(cow_ccode_source= replace(cow_ccode_source, source=="YUG", 345), #The function countrycode did not identify "YUG" as Yugoslavia.
#         cow_ccode_target = replace(cow_ccode_target, target=="YUG", 345), #The function countrycode did not identify "YUG" as Serbia, then part of Yugoslavia.
#         cow_ccode_source= replace(cow_ccode_source, source=="SER", 345), #The function countrycode did not identify "SER" as Serbia, then part of Yugoslavia.
#         cow_ccode_target = replace(cow_ccode_target, target=="SER", 345)) #The function countrycode did not identify "SER" as Serbia, then part of Yugoslavia.
  mutate(cow_ccode=ifelse(cow_ccode_source==2,cow_ccode_target, cow_ccode_source),
         ccode_type=ifelse(cow_ccode_source==2,"target", "source")
         ) %>%
  select(year, cow_ccode, ccode_type, vcoop, mcoop, vcon, mcon) %>%
  filter(!is.na(cow_ccode))  %>%
  group_by(.dots=c("year","cow_ccode")) %>%
  tally() %>%
  right_join(states_70s_year, by=c("cow_ccode", "year")) %>%
  ungroup() %>%
  rename(evt_n_c_y=n) %>%
  mutate(evt_n_c_y= replace(evt_n_c_y, is.na(evt_n_c_y), 0))
```

#Compare the country-year data
```{r}
setwd("/Users/clarahsuong/chronos_data_intro")

us_dip_c_y<-
  cable_n_states_70s_year[cable_n_states_70s_year$cow_ccode!=2,] %>%
  left_join(us_dip_rep_moyer, by=c("cow_ccode", "year")) %>%
  left_join(us_dip_rep_app, by=c("year", "cow_ccode", "cow_stateabb","cow_statename")) %>%
  left_join(us_dip_vis, by=c("year", "cow_ccode", "cow_stateabb","cow_statename")) %>%
  left_join(us_dip_evt, by=c("year", "cow_ccode", "cow_stateabb","cow_statename")) %>%
#  mutate(rep_diff=ifelse(dip_rep_a!=dip_rep_m,1, 0)) %>%
  group_by(cow_ccode) %>%
  mutate(lag.n_c_y = dplyr::lag(n_c_y, n = 1, default = NA)) %>%
  ungroup()

#How is dip_rep_m different from dip_rep_a?
#table(us_dip_c_y$rep_diff)

stargazer(as.data.frame(us_dip_c_y)[c("year","cow_ccode",
                                      "n_c_y",
                                      "dip_rep_m","dip_focus",
                                      "politicalappointee_year",#"performanceMU_year","ambassador_year",
                                      "bi_PRE", #"bi_SOS"
                                      "evt_n_c_y")], 
          type = "text", 
          title="Summary Statistics of Variables on US Diplomacy (Unit: Country-Year)", 
          digits=1, 
          out="./data_analysis_output/desc_us_dip_states_70s_year.txt",
          covariate.labels=c("Year", "COW Country Codes", 
                             "Tag Traffic",
                            "US Diplomatic Representation","US Diplomatic Focus",
                            "US Ambassador Is a Political Appointee",
                            "Number of US Presidential Visits",
                            "Number of US Diplomatic Events")
          )

stargazer(as.data.frame(us_dip_c_y)[c("year","cow_ccode",
                                      "n_c_y",
                                      "dip_rep_m","dip_focus",
                                      "politicalappointee_year",#"performanceMU_year","ambassador_year",
                                      "bi_PRE"#, "bi_SOS"
                                      )],  
          type = "html", 
          title="Summary Statistics of Variables on US Diplomacy", 
          digits=1, 
          out="./data_analysis_output/desc_us_dip_states_70s_year.html",
          covariate.labels=c("Year", "COW Country Codes", 
                             "Tag Traffic",
                            "US Diplomatic Representation","US Diplomatic Focus",
                            "US Ambassador Is a Political Appointee",
                            "Number of US Presidential Visits",
                            "Number of US Diplomatic Events"))
```  

#Unbalanced panel
```{r}
nrow(us_dip_c_y[us_dip_c_y$year==1973,])
nrow(us_dip_c_y[us_dip_c_y$year==1974,])
nrow(us_dip_c_y[us_dip_c_y$year==1975,])
nrow(us_dip_c_y[us_dip_c_y$year==1976,])
nrow(us_dip_c_y[us_dip_c_y$year==1977,])
nrow(us_dip_c_y[us_dip_c_y$year==1978,])
nrow(us_dip_c_y[us_dip_c_y$year==1979,])
```

##Correlation plots
```{r}
DF<-us_dip_c_y[c("n_c_y","dip_focus","dip_rep_m",
                                     #"dip_rep_a",
                                     "nationrank", "politicalappointee_year","performanceMU_year","ambassador_year",
                                     "bi_PRE","bi_SOS","evt_n_c_y")]
M<-cor(DF, use = "complete.obs")
M
corrplot(M, method = "ellipse")
#corrplot.mixed(M)

res1 <- cor.mtest(DF, conf.level = .95)
res2 <- cor.mtest(DF, conf.level = .99)

corrplot(M, p.mat = res1$p, sig.level = .05)
```

#Negative binomial models with fixed effects for unbalanced panel
```{r, results='asis', warning=FALSE,message=FALSE}
setwd("/Users/clarahsuong/chronos_data_intro")

#coef_test(fixed_rep_a, vcov = "CR1", cluster = "individual", test = "naive-t")

fixed_rep_m <- pglm(n_c_y~
                   dip_rep_m#+
                   #dip_focus+
                   #dip_rep_a+
                   #politicalappointee_year+
                   #performanceMU_year+
                   #bi_PRE+
                   #bi_SOS+
                   #evt_n_c_y
               ,
               data=us_dip_c_y, 
               index=c("cow_ccode", "year"), 
               family = negbin, 
              effect = "twoways",
               model="within", 
               method = "nr",
               print.level = 0
              )
m_rep_m=summary(fixed_rep_m)
m_rep_m

fixed_rep_m2 <- pglm(n_c_y~
                   #dip_rep_m+
                   dip_focus#+
                   #dip_rep_a#+
                   #politicalappointee_year+
                   #performanceMU_year+
                   #bi_PRE+
                   #bi_SOS+
                   #evt_n_c_y
               ,
               data=us_dip_c_y, 
               index=c("cow_ccode", "year"), 
               family = negbin, 
               model="within", 
               effect = "twoways",
               method = "nr",
               print.level = 0
              )
m_rep_m2=summary(fixed_rep_m2)
m_rep_m2

fixed_rep_app <- pglm(n_c_y~
                   #dip_rep_m+
                   #dip_focus+
                   #dip_rep_a+
                   politicalappointee_year#+
                   #ambassador_year
                   #performanceMU_year#+
                   #bi_PRE+
                   #bi_SOS+
                   #evt_n_c_y
               ,
               data=us_dip_c_y, 
               index=c("cow_ccode", "year"), 
               family = negbin, 
               model="within", 
               effect = "twoways",
               method = "nr",
               print.level = 0
              )
m_rep_app=summary(fixed_rep_app)
m_rep_app


fixed_vis1 <- pglm(n_c_y~
                   #dip_rep_m+
                   #dip_focus+
                   #dip_rep_a+
                   #politicalappointee_year+
                   #performanceMU_year#+
                   bi_PRE#+
                   #bi_SOS#+
                   #evt_n_c_y
               ,
               data=us_dip_c_y, 
               index=c("cow_ccode", "year"), 
               family = negbin, 
               model="within", 
               effect = "twoways",
              method = "nr",
               print.level = 0
              )
m_vis1=summary(fixed_vis1)
m_vis1

fixed_evt <- pglm(n_c_y~
                   #dip_rep_m+
                   #dip_focus+
                   #dip_rep_a+
                   #politicalappointee_year+
                   #performanceMU_year#+
                   #bi_PRE#+
                   #bi_SOS#+
                   evt_n_c_y
               ,
               data=us_dip_c_y, 
               index=c("cow_ccode", "year"), 
               family = negbin, 
               model="within", 
               effect = "twoways",
               method = "nr",
               print.level = 0)
m_evt=summary(fixed_evt)
m_evt
```

##Table for the negative binomial models
```{r}
setwd("/Users/clarahsuong/chronos_data_intro")

htmlreg(list(fixed_rep_m, 
             fixed_rep_m2,
             fixed_rep_app, 
             fixed_vis1,
             fixed_evt), 
    custom.coef.names = c("(Intercept)", 
                          "US Diplomatic Representation",
                          "US Diplomatic Focus",
                          "US Ambassador is a political appointee",
                          "Number of US Presidential Visits",
                          "Number of US Diplomatic Events"),
    file = "./data_analysis_output/pgml_us_dip_c_y.html", 
    caption = "Negative Binomial Regression of Tag Traffic with Fixed Effects (Unit: Country-Year)", 
    caption.above= TRUE,     
    inline.css = FALSE, doctype = TRUE, html.tag = TRUE, 
    head.tag = TRUE, body.tag = TRUE)
#unlink("texreg.doc")
```

#Comparison of different diplomacy variables
```{r}
setwd("/Users/clarahsuong/chronos_data_intro")

#Re-connect to the database
#driver = dbDriver("MySQL")
#connection = dbConnect(driver,host='history-lab.org', password='XreadF403', user='de_reader')
#mydb = dbConnect(driver,host='history-lab.org', password='XreadF403', user='de_reader', dbname='declassification_cables')

table_us_dip_comp<-
  us_dip_c_y %>%
  filter(dip_rep_m==0 & dip_rep_a==0 
         & evt_n_c_y==0
         ) %>% #Note that the variable dip_rep_m=0 for South Vietnam, which is inaccurate
  arrange(desc(n_c_y)) %>%
  top_n(n = 20, wt = n_c_y) 

stargazer(table_us_dip_comp[c("year",
                              "cow_statename",
                               "n_c_y",
                              "dip_rep_m",
                              "dip_focus",
                              "politicalappointee_year",
                              "bi_PRE",
                              "evt_n_c_y")],
          type = "html", 
          #flip = TRUE,
          summary = FALSE,
          rownames = FALSE,
          title="Comparison of Variables on US Diplomacy", 
          digits=1, 
          out="./data_analysis_output/us_dip_comp.html",
          covariate.labels=c("Year", 
                             "Country", 
                             "Number of Cables Tagged",
                             "US Diplomatic Representation",
                            "US Diplomatic Focus",
                            "US Ambassador is a political appointee",
                            "Number of US Presidential Visits",
                            "Number of US Diplomatic Events")
          )
          
stargazer(table_us_dip_comp[c("year",
                              "cow_statename",
                               "n_c_y",
                              "dip_rep_m",
                              "dip_focus",
                              "politicalappointee_year",
                              "bi_PRE",
                              "evt_n_c_y")],
          type = "text", 
          #flip = TRUE,
          summary = FALSE,
          rownames = FALSE,
          title="Comparison of Variables on US Diplomacy", 
          digits=1, 
          out="./data_analysis_output/us_dip_comp.txt",
          covariate.labels=c("Year", 
                             "Country", 
                             "Number of Cables Tagged",
                             "US Diplomatic Representation",
                            "US Diplomatic Focus",
                            "US Ambassador is a political appointee",
                            "Number of US Presidential Visits",
                            "Number of US Diplomatic Events")
          )

#Cuba, North Korea, GDR, Iran
troublemaker<-
  us_dip_c_y %>%
  filter(cow_statename=="Cuba" | 
         cow_statename=="North Korea" |
         cow_statename=="German Democratic Republic" |
         cow_statename=="Iran")
          
png("./data_analysis_output/us_dip_comp_troublemaker.png", width = 800, height = 600)
#layout(matrix(c(1:3), 3, 1,
# byrow = TRUE))
ggplot(troublemaker, aes(x = month2, y = sum_monthly)) + 
  geom_line(aes(color = cow_statename), size = 1) +
  labs(#title = "Tag Traffic of Key 10 Countries",
           subtitle = "Data Plotted by Month",
           y = "Tag Traffic Volume",
           x = "Date") + 
  theme_bw() +
  theme(legend.title=element_blank(), 
        legend.position = c(0, 1), 
        legend.justification = c(0, 1))
dev.off()
g2 <- ggplotGrob(p2)
g3 <- ggplotGrob(p3)
g <- rbind(g2, g3, size = "first")
g$widths <- unit.pmax(g2$widths, g3$widths)
grid.newpage()
grid.draw(g)
```

```{r, echo=FALSE}
#Unestimatable or unused pglm models
fixed_rep_a <- pglm(n_c_y~
                   #dip_rep_m#+
                   #dip_focus+
                   dip_rep_a#+
                   #nationrank+ 
                   #politicalappointee_year+
                   #performanceMU_year+
                   #ambassador_year+
                   #bi_PRE+
                   #bi_SOS+
                   #evt_n_c_y+
                   #lag.n_c_y
                     ,
               data=us_dip_c_y, 
               #effect = "twoways",
               index=c("cow_ccode", "year"), 
               family = negbin, 
               model="within", 
               method = "nr",
               print.level = 0
              )
m_rep_a=summary(fixed_rep_a)
m_rep_a

fixed_vis2 <- pglm(n_c_y~
                   #dip_rep_m+
                   #dip_focus+
                   #dip_rep_a+
                   #politicalappointee_year+
                   #performanceMU_year#+
                   #bi_PRE#+
                   bi_SOS#+
                   #evt_n_c_y
               ,
               data=us_dip_c_y, 
               index=c("cow_ccode", "year"), 
               family = negbin, 
               model="within", 
               effect = "twoways",
              method = "nr",
               print.level = 0
              )
m_vis2=summary(fixed_vis2)
m_vis2

fixed_rep_m2_evt <- pglm(n_c_y~
                   dip_rep_m+
                   dip_focus+
                   #dip_rep_a+
                   #politicalappointee_year+
                   #performanceMU_year#+
                   #bi_PRE#+
                   #bi_SOS#+
                   evt_n_c_y
               ,
               data=us_dip_c_y, 
               index=c("cow_ccode", "year"), 
               family = negbin, 
               model="within", 
               effect = "twoways",
               method = "nr",
               print.level = 0)
m_rep_m2_evt=summary(fixed_rep_m2_evt)
m_rep_m2_evt

fixed_rep_m_app <- pglm(n_c_y~
                   dip_rep_m+
                   #dip_focus+
                   #dip_rep_a+
                   politicalappointee_year#+
                   #performanceMU_year#+
                   #bi_PRE+
                   #bi_SOS+
                   #evt_n_c_y
               ,
               data=us_dip_c_y, 
               index=c("cow_ccode", "year"), 
               family = negbin, 
               model="within", 
               method = "nr",
               print.level = 0
              )
m_rep_m_app=summary(fixed_rep_m_app)
m_rep_m_app

fixed_rep_m_evt <- pglm(n_c_y~
                   dip_rep_m+
                   #dip_focus+
                   #dip_rep_a+
                   #politicalappointee_year+
                   #performanceMU_year#+
                   #bi_PRE#+
                   #bi_SOS#+
                   evt_n_c_y
               ,
               data=us_dip_c_y, 
               index=c("cow_ccode", "year"), 
               family = negbin, 
               model="within", 
               method = "nr",
               print.level = 0)
m_rep_m_evt=summary(fixed_rep_m_evt)
m_rep_m_evt

fixed_dip <- pglm(n_c_y~
                   dip_rep_m+
                   #dip_focus+
                   #dip_rep_a+
                   politicalappointee_year+
                   #performanceMU_year#+
                   #bi_PRE+
                   #bi_SOS+
                   evt_n_c_y
               ,
               data=us_dip_c_y, 
               index=c("cow_ccode", "year"), 
               family = negbin, 
               model="within", 
               effect = "twoways",
               method = "nr",
               print.level = 0)
m_dip=summary(fixed_dip)
m_dip

fixed1.5 <- pglm(n_c_y~
                   #dip_rep_m+
                   #dip_focus+
                   #dip_rep_a+
                   #politicalappointee_year+
                   #performanceMU_year#+
                   #bi_PRE#+
                   #bi_SOS#+
                   evt_n_c_y
               ,
               data=us_cable_n_dip_rep_app_vis_evt, 
               index=c("cow_ccode", "year"), 
               family = negbin, 
               model="within", 
               method = "nr"
              )

fixed1.6 <- pglm(n_c_y~
                   dip_rep_m+
                   dip_focus+
                   #dip_rep_a+
                   politicalappointee_year+
                   #performanceMU_year#+
                   #bi_PRE#+
                   #bi_SOS#+
                   evt_n_c_y
               ,
               data=us_cable_n_dip_rep_app_vis_evt, 
               index=c("cow_ccode", "year"), 
               family = negbin, 
               method = "nr",
               print.level = 0)

fixed_rep_m_app_vis_evt <- pglm(n_c_y~
                   dip_rep_m+
                   dip_focus+
                   #dip_rep_a+
                   politicalappointee_year+
                   ##performanceMU_year#+
                   bi_PRE+
                   #bi_SOS+
                   evt_n_c_y
               ,
               data=us_dip_c_y, 
               index=c("cow_ccode", "year"), 
               family = negbin, 
               method = "nr"
               ,print.level = 0
               )
m_rep_m_app_vis_evt=summary(fixed_rep_m_app_vis_evt)
m_rep_m_app_vis_evt


fixed2 <- pglm(n_c_y~
                   dip_rep_m+
                   dip_focus+
                   #bi_PRE+
                   bi_SOS+
                   evt_n_c_y
               ,
               data=us.cable_n.rep_m.vis.evt, 
               index=c("cow_ccode", "year"), 
               family = negbin, 
               model="within", 
               method = "nr"
              )
#summary(fixed2)


# "pooling"
pooling1 <- pglm(n_c_y~
                   dip_rep_m+
                   dip_focus+
                   bi_PRE+
                   #bi_SOS+
                   evt_n_c_y,
                 data=us.cable_n.rep_m.vis.evt, 
                 index=c("cow_ccode", "year"), 
                 family = negbin, 
                 model="pooling", 
                 method = "nr"
                 )
summary(pooling1)

pooling2 <- pglm(n_c_y~
                   dip_rep_m+
                   #dip_focus+
                   bi_PRE+
                   #bi_SOS+
                   evt_n_c_y,
                 data=us.cable_n.rep_m.vis.evt, 
                 index=c("cow_ccode", "year"), 
                 family = negbin,
                 index=c("cow_ccode", "year"), family = negbin, model="pooling"#, method = "nr"
              )
summary(pooling2)

#Negative binomial models without panel effect and with cluster SEs and lagged years

glm.nb_irep1 <- glm.nb(n_c_y~dip_irep, data = cable_n_irep_app)

glm.nb_amb <- glm.nb(n_c_y~ambassador, data = cable_n_irep_app)

glm.nb_politicalappointee <- glm.nb(n_c_y~politicalappointee, data = cable_n_irep_app)

glm.nb_good <- glm.nb(n_c_y~good, data = cable_n_irep_app)

glm.nb_bad <- glm.nb(n_c_y~bad, data = cable_n_irep_app)

stargazer(glm.nb_irep1,
          glm.nb_amb,
          glm.nb_politicalappointee, 
          glm.nb_good,
          glm.nb_bad,
          type="text",
          dep.var.labels=c("Number of Cables Tagged"),
          #covariate.labels=c("Gross horsepower","Rear axle ratio","Four foward gears","Five forward gears","Type of transmission (manual=1)"), 
          out="../data_analysis_output/cable_n_irep_app.txt")

#Slightly modified from the analysis in Lebovic and Saunders (2016)' Tables 3 and 4
glm.nb_pre2 <- glm.nb(n_c_y~bi_PRE+mil_ratio+USmilaid+allies+USdefense+USdefense_EUR+UStrade+energypc+USalign+UNpart+mpower+FOR+CAR+demo+bi_L1_PRE+EUR+AFR+MEA+SCA+EAP, data = cable_n_vis_country_y)
#Cluster by cowid

glm.nb_sos2 <- glm.nb(n_c_y~bi_SOS+mil_ratio+USmilaid+allies+USdefense+USdefense_EUR+UStrade+energypc+USalign+UNpart+mpower+FOR+CAR+demo+bi_L1_PRE+EUR+AFR+MEA+SCA+EAP, data = cable_n_vis_country_y)
#Cluster by cowid

glm.nb_pre3 <- glm.nb(n_c_y~bi_PRE+mil_ratio+USmilaid+allies+USdefense+USdefense_EUR+UStrade+energypc+USalign+UNpart+mpower+FOR+CAR+demo+bi_L14_SOS+bi_L14_PRE+bi_L58_SOS+bi_L58_PRE+EUR+AFR+MEA+SCA+EAP, data = cable_n_vis_country_y)
#Cluster by cowid

glm.nb_sos3 <- glm.nb(n_c_y~bi_SOS+mil_ratio+USmilaid+allies+USdefense+USdefense_EUR+UStrade+energypc+USalign+UNpart+mpower+FOR+CAR+demo+bi_L14_SOS+bi_L14_PRE+bi_L58_SOS+bi_L58_PRE+EUR+AFR+MEA+SCA+EAP, data = cable_n_vis_country_y)
#Cluster by cowid

#Check model assumptions and robustness (https://stats.idre.ucla.edu/r/dae/negative-binomial-regression/)

#Consider using the event count time series models PAR(p) and PEWMA models (http://www.utdallas.edu/~pbrandt/Patrick_Brandts_Website/Code_%26_Software.html) or negative binomials or tscount (https://cran.r-project.org/web/packages/tscount/vignettes/tsglm.pdf) for robustness check.

#Negotive binomial regression models
stargazer(glm.nb_pre1, glm.nb_pre2, glm.nb_pre3, 
          type="html",
          dep.var.labels=c("Number of Cables Tagged"),
          #covariate.labels=c("Gross horsepower","Rear axle ratio","Four foward gears","Five forward gears","Type of transmission (manual=1)"), 
          out="../data_analysis_output/cable_n_pres_visit.html"
          )

stargazer(glm.nb_sos1, glm.nb_sos2, glm.nb_sos3, 
          type="html",
          dep.var.labels=c("Number of Cables Tagged"),
          #covariate.labels=c("Gross horsepower","Rear axle ratio","Four foward gears","Five forward gears","Type of transmission (manual=1)"), 
          out="../data_analysis_output/cable_n_sos_visit.html"
          )

stargazer(glm.nb_pre1, glm.nb_pre2, glm.nb_pre3, glm.nb_sos1, glm.nb_sos2, glm.nb_sos3, 
          type="html",
          dep.var.labels=c("Number of Cables Tagged"),
          #covariate.labels=c("Gross horsepower","Rear axle ratio","Four foward gears","Five forward gears","Type of transmission (manual=1)"), 
          out="../data_analysis_output/cable_n_visit.html")

stargazer(glm.nb_irep1, glm.nb_app1,
          type="text",
          dep.var.labels=c("Number of Cables Tagged"),
          #covariate.labels=c("Gross horsepower","Rear axle ratio","Four foward gears","Five forward gears","Type of transmission (manual=1)"), 
          out="../data_analysis_output/cable_n_irep_app.txt")
```